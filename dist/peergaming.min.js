/**
 *	peergaming.min.js - v0.4.7 | 2013-06-30
 *	http://peergaming.net
 *	Copyright (c) 2013, Stefan DÃ¼hring
 *	MIT License
 */

(function(R,S,B){"undefined"!==typeof module?module.exports=B(S):"undefined"!==typeof define?define(R,function(){return B(S)}):S[R]=B(S)})("pg",this,function(R,S){function B(a){console.warn("[ERROR] ",a);console.warn(a.name+": "+a.message)}function oa(a){z(r,a);return r}function z(a){for(var b,c,d=1,l=arguments.length;d<l;d++)for(c in b=arguments[d],b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function L(a,b){a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})}
function Ha(a){if("object"==typeof a){for(var b=h(a),c=[],d=0,l=b.length;d<l;d++)c[d]=a[b]+"/";return c.join("")}}function pa(a){var b=[],c;b.push.apply(b,arguments);for(b.shift();a.length;)c=a.shift(),"function"===typeof c&&c.apply(c,b)}function va(a,b){var c=C[a].reference,d=h(c),l=h(b),e=[],k=[],m,p;m=0;for(p=d.length;m<p;m++)void 0==b[d[m]]&&k.push(d[m]);m=0;for(p=l.length;m<p;m++)void 0==c[l[m]]&&e.push(l[m]);if(e.length||k.length){d=0;for(l=e.length;d<l;d++)Ia(a,b,e[d]);d=0;for(l=k.length;d<
l;d++)delete c[k[d]]}setTimeout(va,da,a,b)}function Ia(a,b,c){var d=function(b){function d(b){C[a].reference[c]=b;var k=C[a].callbacks,p,e;p=0;for(e=k.length;p<e;p++)k[p].apply(k[p],[c,b]);return b}function k(a,b){a[b]=function(){Array.prototype[b].apply(this,arguments);return d(a)}}if(b!==C[a].reference[c]){if("object"===typeof b)if(Array.isArray(b))b=z(qa(function(b,k){var p=C[a].reference[c];p[b]=k;return d(p)}),b);else for(var e="pop push reverse shift sort splice unshift".split(" "),p=0,ra=e.length;p<
ra;p++)k(b,e[p]);d(b)}};d(b[c]);Object.defineProperty(b,c,{enumerable:!0,configurable:!0,get:function(){return C[a].reference[c]},set:d})}function wa(a){if(0>a.indexOf("a=crypto")){for(var b=[],c=4;c--;)b.push(Math.random().toString(36).substr(2,10));a+="a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:"+b.join("")+"\r\n"}0<=a.indexOf("b=AS")&&(a=a.replace(/b=AS:([0-9]*)/,function(a,b){return"b=AS:"+r.handlerConfig.BANDWIDTH}));0<=a.indexOf("a=mid:data")&&(a=a.replace(/a=mid:data\r\n/g,function(a,b){return"a=mid:data\r\nb=AS:"+
r.handlerConfig.BANDWIDTH+"\r\n"}));return a}function xa(a){var b=this._sendSDP;this._sendSDP=function(b){this.send("expectPackages",{type:"candidates",size:b});this.send("setConfigurations",a)}.bind(this);void 0!=b&&this._sendSDP(b)}function ya(a){if(!h(a.channels).length)for(var b=h(T),c=0,d=b.length;c<d;c++)a.createDataChannel(b[c])}function Ja(a,b,c){b={action:a,local:g.id,data:b,remote:this.info.remote};z(b,c);c=this.ready;var d=this.channels;a||(a=h(d));Array.isArray(a)||(a=[a]);for(var e=0,
f=a.length;e<f;e++)c&&d[a[e]]&&d[a[e]].send(b)}function Ka(a){if(r.reconnectConfig.restoreEnabled&&(F.id&&(a.id=F.id),F.time&&(a.time=F.time),F.data)){a=a.data;for(var b=F.data,c=h(b),d=0,e=c.length;d<e;d++)a[c[d]]=b[c[d]]}}function za(a,b){var c=Aa();G.player=g=new U(a,c);b&&b(g);g.join(c)}function Aa(){var a=e.location.hash,a=a.length?a.substr(3):ea;return"/"===a.charAt(0)?a.substr(1):a}function Ba(){var a=Aa(),b=a.split("/");M.route=N.route=a;if(!(1>b.length))if(a=b.shift()){var c=b[0].length?
"GAME":"CHANNEL";A=a="CHANNEL"===c?sa[a]||sa["*"]:fa[b[0]]||fa["*"];if(ga!==M.route){if(a){if(ga){b=h(n);a=0;for(c=b.length;a<c;a++)v.disconnect(b[a]);ha.send({action:"change",data:ga})}}else console.warn("[MISSING] ",c," handler doesn't exist!");ga=M.route}}else e.location.hash="!/"+ea}function Ca(a){return function(b,c){"string"!==typeof b&&(c=b,b="*");var d=new a(b);(d instanceof H?fa:sa)[b]=d;c(d);return d}}function V(a){this.init(a);this.match=function(a){}}function H(a){this.init(a);this.info=
{};this.options={minPlayer:2,maxPlayer:8};fa[a]=this}function La(){for(var a=h(s),b=g.pos,c=0,d=a.length;c<d;c++)if(b-1===s[a[c]].pos)return n[a[c]].send("start",{request:!0},!0)}function ta(a){O=function(){O=null;setTimeout(function(){for(var a=h(s),b=g.pos,c=0,d=a.length;c<d;c++)if(b+1===s[a[c]].pos){n[a[c]].send("start");break}this._start&&delete this._start}.bind(this),5*P)}.bind(this);if(a){a=n[a];for(var b=h(G.sync),c,d=0,e=b.length;d<e;d++)c=b[d],a.send("sync",{resync:!0,key:c,value:G.sync[c]},
!0);O&&O()}}function Ma(){var a=new Uint8Array(1),b,c;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){b=crypto.getRandomValues(a)[0]%16;c="x"===d?b:b&3|8;return c.toString(16)})}function W(a){function b(){c=e.performance.now();d=c-l;l=c;a(d);ia&&requestAnimationFrame(b)}if(!ia){ia=!0;Da=a;var c=0,d=0,l=0;requestAnimationFrame(function(){l=e.performance.now();b()})}}function ja(a,b,c){if(c)I[a]&&I[a].results[g.pos]===b||(ua[a]=!0,G.sync[a]=b),delete I[a];else if(!I[a])if(ua[a])delete ua[a];
else{c=h(n);I[a]={list:c,results:[]};I[a].results[g.pos]=b;for(var d=0,e=c.length;d<e;d++)n[c[d]].send("sync",{key:a,value:b},!0)}}var e=window,x=document,u=e.navigator,J=u.mozGetUserMedia?parseFloat(u.userAgent.match(/Firefox\/([0-9]+)\./).pop()):!1,X=e.chrome?parseFloat(u.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./).pop()):!1,N=e.sessionStorage,Q=e.localStorage,h=Object.keys,A="",D=[],n={},ha=null,v=null,ka=!1,Y=null,F={},q=null,M={},g=null,s={},Z=[],da=null;e.performance?e.performance.now||(e.performance.now=
e.performance.webkitNow):e.performance={now:Date().now()};if(!e.requestAnimationFrame)for(var t=["webkit","moz"],q=0,K=t.length;q<K&&!e.requestAnimationFrame;q++)e.requestAnimationFrame=e[t[q]+"RequestAnimationFrame"],e.cancelAnimationFrame=e[t[q]+"CancelAnimationFrame"]||e[t[q]+"CancelRequestAnimationFrame"];var la;if(!("hidden"in x)){t=["webkit","moz","ms","o"];x.state&&(t.length=0);q=0;for(K=t.length;q<K;q++)t[q]+"Hidden"in x&&(x.state=x[t[q]+"VisibilityState"],x.hidden=x[t[q]+"Hidden"],la=t[q]+
"visibilitychange");la||(la="visibilitychange")}e.URL||(e.URL=e.webkitURL||e.msURL||e.oURL);e.Blob||e.BlobBuilder||(e.BlobBuilder=e.BlobBuilder||e.WebKitBlobBuilder||e.MozBlobBuilder||e.MSBlobBuilder||e.OBlobBuilder);e.setImmediate||(e.setImmediate=function(){var a=[];e.addEventListener("message",function(){a.shift()()},!0);return function(b){if("function"!==typeof b)throw Error("Invalid Argument");a.push(b);e.postMessage("setImmediate","*")}}());u.getUserMedia||(u.getUserMedia=(u.mozGetUserMedia||
u.webkitGetUserMedia||u.msGetUserMedia).bind(u));"function"!==typeof e.RTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection||e.webkitRTCPeerConnection,e.RTCPeerConnection=function(){var a=e.RTCPeerConnection;return function(b,c){for(var d=b.iceServers,e,f,k,m,p=0,ra=d.length;p<ra;p++){e=d[p];f=null;k=e.url;m=k.split(":")[0];"stun"===m&&(f={url:k});"turn"===m&&(f=k,k=e.username,m=e.password,f=!J||-1===f.indexOf("transport=udp")&&-1!==f.indexOf("?transport")?X?28<X?{url:f,credential:m,username:k}:
{url:"turn:"+k+"@"+f.split("turn:")[1],credential:m}:void 0:{url:f.split("?")[0],credential:m,username:k},f=f||{});if(!f.url)throw Error("Invalid server address - ",e);d[p]=f}return new a(b,c)}}());"function"!==typeof e.RTCSessionDescription&&(e.RTCSessionDescription=e.mozRTCSessionDescription);"function"!==typeof e.RTCIceCandidate&&(e.RTCIceCandidate=e.mozRTCIceCandidate);J&&(MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]});e.webkitRTCPeerConnection&&
!e.webkitRTCPeerConnection.prototype.getLocalStreams&&(e.webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},e.webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams},e.webkitMediaStream.prototype.getVideoTracks||(e.webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},e.webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}));u=["URL","Blob","crypto","RTCPeerConnection"];q=0;for(K=
u.length;q<K;q++)u[q]in e||console.log("Missing: ",u[q]);if(!e.RTCPeerConnection)return alert("Your browser doesn't support PeerConnections yet.");(function(){var a=new Uint32Array(1),b=new Uint8Array(a.buffer);a[0]=255;return!!b[0]})();e.clearDebug=function(){delete Q.log};var Na=R.pg,G=Object.create(null),q={codeName:"spicy-phoenix",full:"0.4.7",major:0,minor:4,dot:7},r={reconnectConfig:{restoreEnabled:!1,backupDuration:18E5},handlerConfig:{BANDWIDTH:1048576,MAX_BYTES:1024,CHUNK_SIZE:600},socketConfig:{server:"ws://peergaming.net:61125"},
connectionConfig:{iceServers:[{url:J?"stun:23.21.150.121":"stun:stun.l.google.com:19302",username:null,password:null}]},connectionConstraints:{optional:[{RtpDataChannels:!0}]},channelConfig:{reliable:!1},mediaConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},optional:[]},videoConstraints:{mandatory:{maxHeight:320,maxWidth:240},optional:[{minWidth:640,minHeight:480},{minWidth:1280,minHeight:720}]}};oa.noServer=function(a){"function"===typeof a&&(Y=a)};oa.localDev=function(){};
var C=[],da=100,qa=function(){var a=[],b=Object.create(Object.prototype);a.push.apply(a,arguments);C.push({reference:{},callbacks:a});va(C.length-1,b);return b},$={},y=function(){this instanceof E?$[this.id]={}:this._events={};return this};y.prototype.on=function(a,b,c){if("function"===typeof b){a=a.split(" ");for(var d=this instanceof E?$[this.id]:this._events,e=a.length,f;e--;)f=a[e],d[f]||(d[f]=[]),d[f].push([b,c]);return this}};y.prototype.once=function(a,b,c){this.on(a,function l(){this.off(a,
l);b.apply(this,arguments)}.bind(this));return this};y.prototype.emit=function(a){var b=(this instanceof E?$[this.id]:this._events)[a];if(b)for(var c=Array.prototype.slice.call(arguments,1),d=b.length;d--;)b[d][0].apply(b[d][1],c||[]);return this};y.prototype.off=function(a,b){var c=this instanceof E?$[this.id]:this._events,d=c[a];if(d){if(b)for(c=d.length;c--;){if(d[c]===b){d.splice(c,1);break}}else c[a].length=0;return this}};var aa=function(a){a||(a={});this.writeable=this.readable=a.readable;
this.ready=!0;this.writeBuffer=[];this.readBuffer=[];y.call(this)};L(aa,y);aa.prototype.handle=function(a){a=a.data;var b=JSON.parse(a),c=this.readBuffer;if(void 0!=b.part){c.push(b.data);this.emit("data",b,c.length);if(0<b.part)return;a=c.join("");c.length=0}this.emit("end",a)};aa.prototype.write=function(a){this.writeBuffer.push(a);this.ready&&this.emit("write",this.writeBuffer.shift());return this.ready};aa.prototype.pipe=function(a){this.on("data",function(b){a.handle(b)});return a};var ma=function(a,
b){var c=a.label;this.info={label:c,remote:b};this.channel=a;this.stream=new aa({readable:!0,writeable:!0});this.actions=T[c]||T.custom;"function"===typeof this.actions&&(this.actions={end:this.actions});a.addEventListener("open",this.init.bind(this))};ma.prototype.init=function(a){for(var b=this.channel,c=this.actions,d=this.stream,e=n[this.info.remote],f=["open","data","end","close","error"],k=0,m=f.length;k<m;k++)d.on(f[k],c[f[k]],e);d.on("write",function(a){b.send(a)});b.onmessage=d.handle.bind(d);
b.onclose=function(){d.emit("close")};b.onerror=function(a){d.emit("error",a)};d.emit("open",a)};ma.prototype.send=function(a){a=JSON.stringify(a);if(a.length>r.handlerConfig.MAX_BYTES){var b=a,c=r.handlerConfig.CHUNK_SIZE,d=b.length;a=[];for(var e=0,f=c;e<d;)a.push(b.slice(e,f)),e=f,f=e+c;b=a.length;for(c=0;b--;)a[b]=JSON.stringify({part:c++,data:a[b]})}else a=[a];b=0;for(c=a.length;b<c;b++)this.stream.write(a[b])};var T={init:{open:function(){delete this.info.pending;this.send("init",{account:g.account,
time:g.time,data:g.data,list:h(n)})},end:function(a){a=JSON.parse(a);var b=s[this.info.remote];a=a.data;z(b.data,a.data);b.time=a.time;b.account=a.account;v.check(a.list,this);v.setup(this.info.remote)},close:function(a){v.disconnect(this.info.remote)}},register:function(a){a=JSON.parse(a);if(a.remote!==g.id)return n[a.remote]?n[a.remote].send("register",a.data,{action:a.action,local:a.local,remote:a.remote}):void 0;v.set(a,this)},ping:function(a){a=JSON.parse(a);var b=a.data;if(!b.pong)return this.send("ping",
{pong:!0,index:b.index});v.setup(a.local,b.index,b.pong)},start:function(a){function b(){if(!A._start)return setTimeout(b,P);A._start()}a=JSON.parse(a);if((a.data||{}).request)return ta(a.local);b()},update:function(a){a=JSON.parse(a);s[a.local].data[a.data.key]=a.data.value},sync:function(a){a=JSON.parse(a);var b=a.data;if(!b.resync){a=a.local;var c=b.key,b=b.value;I[c]?(console.log("[CONFLICT]"),b=void 0):(ja(c,b,!0),b=n[a].send("sync",{resync:!0,key:c,value:b},!0));return b}ja(b.key,b.value,!0)},
message:function(a){g.emit("message",a)},custom:function(a){a=JSON.parse(a);console.log(a.action)}},ha=function(){function a(a,b){var c=new XMLHttpRequest;c.open("POST",r.socketConfig.server,!0);b&&(c.onload=function(a){c.onload=null;b(a.currentTarget.response)});c.setRequestHeader("Content-Type","text/plain; charset=UTF-8");c.send(a)}function b(){k("ws")||Y||(N.id?f({action:"remove",data:N.id},function(){D.length&&(delete N.id,pa(D))}):pa(D))}function c(a){a=JSON.parse(a.data);if(!a||!a.local)return D.length?
pa(D,a):v.check(a);v.set(a)}function d(a){if(a.eventPhase===EventSource.CLOSED)return l();try{a.currentTarget.close(),b()}catch(c){console.log(c)}throw Error(a.data);}function l(){console.log("[SOCKET] - CLOSE")}function f(b,c){z(b,{local:g.id,origin:M.route});b=JSON.stringify(b);if(k("http"))a(b,c);else{c&&D.push(c);if(Y)return Y(b);m.send(b)}}function k(a){return r.socketConfig.server.split(":")[0]===a}b();e.addEventListener("unload",b);e.addEventListener("beforeunload",b);var m=null;return{init:function(a,
b){N.id=a;m=new (k("http")?EventSource:WebSocket)(r.socketConfig.server+"/?local="+a+"&origin="+b);m.addEventListener("error",d);m.addEventListener("open",function(){m.addEventListener("message",c);m.addEventListener("close",l);f({action:"lookup"},function(a){v.check(a)})})},send:f,handle:c}}(),w=function(a,b,c,d){this.info={local:a,remote:b,pending:!0};c&&(this.info.initiator=!0);d&&(this.info.transport=d);this.channels={};this._candidates=[];this._fragments={};this._counter=0;this._sendSDP=null;
this.init()};w.prototype.init=function(){this.conn=new RTCPeerConnection(r.connectionConfig,r.connectionConstraints);this.checkStateChanges();this.receiveDataChannels();this.findICECandidates();this.info.initiator&&this.createOffer()};w.prototype.checkStateChanges=function(){var a=this.conn,b=h(T).length;a.onnegotiationneeded=function(a){--b||this.createOffer()}.bind(this);a.onsignalingstatechange=function(b){this.ready="stable"===a.signalingState}.bind(this);a.oniceconnectionstatechange=function(a){"disconnected"===
a.currentTarget.iceConnectionState&&(this.info.pending?this.closed=!0:v.disconnect(this.info.remote))}.bind(this)};w.prototype.receiveDataChannels=function(){this.conn.ondatachannel=function(a){a=a.channel;this.channels[a.label]=new ma(a,this.info.remote)}.bind(this)};w.prototype.findICECandidates=function(){function a(){var a=this._counter;this._counter=0;if(this._sendSDP)return this._sendSDP(a);this._sendSDP=a}var b=this.conn,c=h(T).length-1,d=!1;this.info.initiator||(c=~~(c/2));b.onicecandidate=
function(e){var f=b.iceGatheringState;e.candidate&&(this._counter++,this.send("setIceCandidates",e.candidate));if(d)--c||a.call(this);else if("complete"===f||J)d=!0,a.call(this)}.bind(this)};w.prototype.setIceCandidates=function(a,b){if(this.closed)throw Error("Can't set ICE candidates!");if(!b)return this._candidates.push(a);for(var c=this.conn,d=a.length,e=0;e<d;e++)c.addIceCandidate(new RTCIceCandidate(a[e]));a.length=0;delete this._fragments.candidates};w.prototype.createOffer=function(){var a=
this.conn;J&&ya(this);this._sendSDP=null;a.createOffer(function(b){b.sdp=wa(b.sdp);a.setLocalDescription(b,function(){xa.call(this,b)}.bind(this),B)}.bind(this),B,r.mediaConstraints)};w.prototype.expectPackages=function(a){this._fragments[a.type]=a.size};w.prototype.setConfigurations=function(a){var b=this.conn,c=new RTCSessionDescription(a);if(this.closed)throw alert("Sorry, but an error occoured. Please revisit the site!"),Error("The underlying PeerConnection got closed too early...");if(this._candidates.length<
this._fragments.candidates)return setTimeout(this.setConfigurations.bind(this),1E3,a);b.setRemoteDescription(c,function(){this._candidates.length&&this.setIceCandidates(this._candidates,!0);this._sendSDP=null;"offer"===a.type?b.createAnswer(function(a){a.sdp=wa(a.sdp);b.setLocalDescription(a,function(){xa.call(this,a)}.bind(this),B)}.bind(this),null,r.mediaConstraints):J||ya(this)}.bind(this),J?function(){}:B)};w.prototype.createDataChannel=function(a){try{var b=this.conn.createDataChannel(a,r.channelConfig);
this.channels[a]=new ma(b,this.info.remote)}catch(c){console.warn("[Error] - Creating DataChannel (*)")}};w.prototype.send=function(a,b,c){if(!this.info.pending)this.send=Ja.bind(this),this.send(a,b);else if(!c){c=this.info.remote;if(this.info.transport)return this.info.transport.send("register",b,{action:a,local:g.id,remote:c});ha.send({action:a,data:b,remote:c})}};w.prototype.close=function(a){var b=this.channels,c=h(b);a||(a=c);Array.isArray(a)||(a=[a]);for(var c=0,d=a.length;c<d;c++)b[a[c]].channel.close(),
delete b[a[c]];h(b).length||this.conn.close()};var P=0,Ea=100,na={},ba={},v=function(){function a(a){function b(a){setTimeout(function(){c.send("ping",{index:a},!0)},Math.random()*d)}var c=n[a],d=Ea;a=l[a]=[d];for(var f=1;f<=d;f++)a[f]=e.performance.now(),b(f)}function b(a){a=Ea-a;var b=h(s).length,c=h(ba).length+b;a=~~(b*a/c);a<=f||A&&A.emit("progress",f=a,c)}function c(){function a(b){na[b.id]||(na[b.id]=!0,g.emit("connection",b),A&&A.emit("enter",b))}var b=h(s),c=[],e;c[g.pos]=g;for(var f=0,l=
b.length;f<l;f++)e=s[b[f]],c[e.pos]=e;if(b=h(ba).pop())return c=ba[b],delete ba[b],v.check(b,c);d();f=0;for(l=c.length;f<l;f++)setTimeout(a,P,c[f])}function d(){var a=h(s),b={};b[g.time]=g.id;for(var c=0,d=a.length;c<d;c++)b[s[a[c]].time]=a[c];var e=h(b).sort(function(a,b){return a-b}).map(function(a){return b[a]});if(e.length!==a.length+1)throw Error("[ERROR] Precision time conflict.");c=Z.length=0;for(d=e.length;c<d;c++)a=s[e[c]]||g,a.pos=Z.push(a.data)-1}var l={},f=0;return{check:function(a,b){if(a){Array.isArray(a)||
(a=[a]);var c=g.id,d=a.pop();this.connect(d,!0,b);if(a.length)for(var e=0,f=a.length;e<f;e++)d=a[e],d===c||n[d]||(ba[d]=b)}},connect:function(a,b,c){n[a]||a===g.id||(s[a]=new E({id:a}),n[a]=new w(g.id,a,b,c))},disconnect:function(a){var b=s[a];b&&(delete na[a],g.emit("disconnect",b),A&&A.emit("leave",b),n[a].close(),Z.splice(b.pos,1),delete s[a],delete n[a],d())},set:function(a,b){n[a.local]||this.connect(a.local,!1,b);n[a.local][a.action](a.data)},update:function(a,b){Q.player=JSON.stringify(g);
for(var c=h(n),d=0,e=c.length;d<e;d++)n[c[d]].send("update",{key:a,value:b},!0)},setup:function(d,f,g){function h(a,b){return a+b}if(!g)return a(d);g=l[d];g[f]=e.performance.now()-g[f];ka||b(g[0]);0<--g[0]||(d=s[d].latency=g.reduce(h)/(g.length-1),P=Math.max(P,d),c())}}}();z(M,{route:null});Q.player&&0<=parseFloat(JSON.parse(Q.player).time)+r.reconnectConfig.backupDuration-Date.now()&&z(F,JSON.parse(Q.player));Q.clear();var Oa={GITHUB:function(a,b){},PERSONA:function(a,b){var c=document.createElement("script");
c.addEventListener("load",function(){navigator.id.watch({loggedInUser:localStorage.user||"",onlogin:function(a){console.log(a)},onlogout:function(){}});navigator.id.request()});c.src="https://login.persona.org/include.js";document.getElementsByTagName("script")[0].parentNode.insertBefore(c)}},ea="lobby/",ga=null,Fa={},Ga={};e.addEventListener("hashchange",Ba);e.addEventListener("popstate",function(a){X&&(X=!X)});var sa={},u=Ca(V);L(V,y);V.prototype.init=function(a){this.id=a;y.call(this)};V.prototype.config=
function(a){z(this.options,a)};var fa={},O=null,K=Ca(H);L(H,V);H.prototype.start=function(a){this._start=function(){a();ka=!0;ta.call(this)};var b=h(na).length;if(!(b<this.options.minPlayer))if(b===this.options.minPlayer){if(0===g.pos){if(!ka)return this._start();ta.call(this,h(G.peers)[0])}}else b>this.options.minPlayer&&g.pos>=this.options.minPlayer&&La()};H.prototype.end=function(){ka=!1};H.prototype.pause=function(){};H.prototype.unpause=function(){};t=function(a,b,c,d){this.info={local:a,remote:b,
pending:!0};c&&(this.info.initiator=!0);d&&(this.info.transport=d);this.channels={};this.init()};t.prototype.init=function(){this.conn=new RTCPeerConnection(r.peerConfig,r.connectionConstraints);this.checkStateChanges();this.findICECandidates();this.info.initiator&&this.requestStream()};L(t,w);t.prototype.attachStream=function(){var a=this.conn;a.onaddstream=function(a){console.log("[MEDIA] - Added Stream");console.log(a)};a.onremovestream=function(a){console.log("[MEDIA] - Removed Stream");URL.revokeObjectURL(a.stream)}};
t.prototype.requestStream=function(a){e.navigator.getUserMedia({audio:!0,video:!0},function(b){b.getVideoTracks();b.getAudioTracks();conn.addStream(b);if(a){var c=document.createElement("video");c.src=createObjectURL(b);c.autoplay=!0;document.getElementById(a).appendChild(c)}})};var E=function(a){this.init(a.id,a.account||{},a.data||{})};L(E,y);E.prototype.init=function(a,b,c){this.id=a;this.account=b;this.data=c;this.pos=Z.push(this.data)-1;y.call(this,a)};var ca={},g={on:function(a,b,c){ca[a]||
(ca[a]=[]);ca[a].push([b,c])}},U=function(a,b){var c=Ma(),d=qa(v.update);this.time=Date.now();this.init(c,a,d);Ka(this);h(ca).length&&($[this.id]=ca);console.log("\n\t\t:: "+this.id+" ::\n");if(Y)return setImmediate(function(){v.check(["SERVERLESS"])});d=function(){ha.init(c,b)};if(!D.length)return d();D.push(d)};L(U,E);U.prototype.join=function(a,b){"string"!==typeof a&&(a=a.toString());"/"===a.charAt(0)&&(a=a.substr(1));var c=["!/",a,Ha(b)].join("");"/"!==c.charAt(c.length-1)&&(c+="/");if(e.location.hash===
c&&c==="!/"+N.route)return Ba();e.location.hash=c};U.prototype.send=function(a,b){b||(b=a,a=null);"string"!==typeof b&&(b=b.toString());a||(a=h(n));Array.isArray(a)||(a=[a]);for(var c=0,d=a.length;c<d;c++)n[a[c]].send("message",{local:this.name,msg:b},!0)};U.prototype.media=function(a,b,c){};var ia=!1,Da=null;W.stop=function(){ia=!1};W.resume=function(){W(Da)};x.addEventListener(la,function(a){a=x.title.split("[PAUSE]").pop();x.hidden||W.stop();x.title=(x.hidden?"[PAUSE] - ":"")+a});var da=qa(function(a){function b(){d=
null;for(var a=h(c),b,e=0,g=a.length;e<g;e++)b=a[e],ja(b,c[b]),delete c[b];O&&O()}var c={},d=null;return function(a,e){c[a]=e;d&&clearTimeout(d);d=setTimeout(b,P)}}(ja)),I={},ua={};z(G,{noConflict:function(){R.pg=Na;return this},VERSION:q,info:M,config:oa,login:function(a,b,c){if(g.id)return g;"function"===typeof b&&(c=b,b=null);if(b)return b=b.toUpperCase(),Oa[b]?(za({name:a},c),a=void 0):a=console.log("[ERROR] The chosen service is not supported yet."),a;za({name:a},c)},player:g,peers:s,data:Z,
sync:da,loop:W,channel:u,game:K,routes:function(a,b){b||"string"!==typeof a||(b=a,a=null);a&&(Fa={},Ga={});b&&(ea=b);return[Fa,Ga,ea]}});return G});
