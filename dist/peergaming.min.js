/**
 *	peergaming.min.js - v0.2.0 | 2013-03-26
 *	http://peergaming.net
 *	Copyright (c) 2013, Stefan DÃ¼hring
 *	MIT License
 */

(function(m,c,n){"undefined"!==typeof module?module.exports=n(c):"undefined"!==typeof define?define(m,function(){return n(c)}):c[m]=n(c)})("pg",this,function(){function m(a){console.log("[error]");console.log(a,a.name+": "+a.message)}var c=window;c.performance?c.performance.now||(c.performance.now=c.performance.webkitNow):c.performance={now:Date().now()};c.URL||(c.URL=c.webkitURL||c.msURL||c.oURL);!c.Blob&&!c.BlobBuilder&&(c.BlobBuilder=c.BlobBuilder||c.WebKitBlobBuilder||c.MozBlobBuilder||c.MSBlobBuilder||
c.OBlobBuilder);if(!c.setImmediate){var n=[];c.addEventListener("message",function(){n.shift()()},!0);c.setImmediate=function(a){if("function"!==typeof a)throw Error("Invalid Argument");n.push(a);c.postMessage("setImmediate","*")}}c.RTCPeerConnection||(c.RTCPeerConnection=c.mozRTCPeerConnection||c.webkitRTCPeerConnection);navigator.getUserMedia||(navigator.getUserMedia=navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia);c.RTCSessionDescription||(c.RTCSessionDescription=
c.mozRTCSessionDescription);c.RTCIceCandidate||(c.RTCIceCandidate=c.mozRTCIceCandidate);c.webkitRTCPeerConnection&&!c.webkitRTCPeerConnection.prototype.getLocalStreams&&(c.webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},c.webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams},c.webkitMediaStream.prototype.getVideoTracks||(c.webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},c.webkitMediaStream.prototype.getAudioTracks=
function(){return this.audioTracks}));for(var t=!!navigator.mozGetUserMedia,g=["URL","Blob","crypto","indexedDB","RTCPeerConnection"],u=0,H=g.length;u<H;u++)g[u]in c||console.log("Missing: ",g[u]);if(!c.RTCPeerConnection)throw Error("Your browser doesn't support PeerConnections yet.");try{var B=new RTCPeerConnection(null);B.createDataChannel("[detect]",{reliable:!1})}catch(I){if(9!==I.code||t)throw Error("Your browser doesn't support DataChannels yet.");}finally{B=null}g=new Uint32Array(1);new Uint8Array(g.buffer);
g[0]=255;c.clearDebug=function(){delete localStorage.log};var l=function(){};l.VERSION="0.2.0";l.peers={};var f,J={iceServers:[{url:!t?"stun:stun.l.google.com:19302":"stun:23.21.150.121"}]},C={optional:[{RtpDataChannels:!0}]},D={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},optional:[]};t&&(D.mandatory.MozDontOfferDataChannel=!0,C.optional[0].DtlsSrtpKeyAgreement=!0);var p={extend:function(a){for(var b,d,e=1,c=arguments.length;e<c;e++)for(d in b=arguments[e],b)b.hasOwnProperty(d)&&(a[d]=
b[d]);return a},inherits:function(a,b){a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})},getToken:function(){return Math.random().toString(36).substr(2,10)},createUID:function(){var a=new Uint8Array(1),b,d;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){b=crypto.getRandomValues(a)[0]%16;d="x"===e?b:b&3|8;return d.toString(16)})},StringToBuffer:function(a){for(var b=new ArrayBuffer(2*a.length),d=new Uint16Array(b),e=0,
c=a.length;e<c;e++)d[e]=a.charCodeAt(e);return b},BufferToString:function(a){return String.fromCharCode.apply(null,new Uint16Array(a))}},g=function(){this.ready=!1;this.list=[]};g.prototype.add=function(a){"function"===typeof a&&this.list.push(a)};g.prototype.exec=function(){this.ready=!0;for(var a=Array.prototype.slice.call(arguments),b=this.list;b.length;)b.pop().apply(null,a)};g.prototype.clear=function(){this.list.length=0};var k=function(){this._events={};return this};k.prototype.on=function(a,
b,d){if("function"===typeof b){a=a.split(" ");for(var e=this._events,c=a.length,j;c--;)j=a[c],e[j]||(e[j]=[]),e[j].push([b,d]);return this}};k.prototype.once=function(a,b){this.on(a,function e(){this.off(type,e);b.apply(this,arguments)}.bind(this))};k.prototype.emit=function(a){var b=this._events[a];if(b)for(var d=Array.prototype.slice.call(arguments,1),e=b.length;e--;)b[e][0].apply(b[e][1],d||[])};k.prototype.off=function(a,b){var d=this._events,e=d[a];if(e)if(b)for(d=e.length;d--;){if(e[d]===b){e.splice(d,
1);break}}else d[a].length=0};var q=function(a){k.call(this);a||(a={});this.writeable=this.readable=a.readable;this.ready=!0;this.writeBuffer=[];this.readBuffer=[]};p.inherits(q,k);q.prototype.handle=function(a){a=a.data;var b=JSON.parse(a),d=this.readBuffer;if(void 0!==b.part){d.push(b.data);this.emit("data",b,d.length);if(0<b.part)return;a=d.join("");d.length=0}this.emit("end",a)};q.prototype.write=function(a){this.writeBuffer.push(a);this.ready&&this.emit("write",this.writeBuffer.shift());return this.ready};
q.prototype.pipe=function(a){this.on("data",function(b){a.handle(b)});return a};var w=function(a,b){var d=a.label;this.info={label:d,remote:b};this.channel=a;this.stream=new q({readable:!0,writeable:!0});this.actions=v[d]||v.custom;"function"===typeof this.actions&&(this.actions={end:this.actions});a.addEventListener("open",this.init.bind(this))};w.prototype.init=function(a){for(var b=this.channel,d=this.actions,e=this.stream,c=f.connections[this.info.remote],j=["open","data","end","close","error"],
x=0,g=j.length;x<g;x++)e.on(j[x],d[j[x]],c);e.on("write",function(a){b.send(a)});b.onmessage=e.handle.bind(e);b.onclose=function(){e.emit("close")};b.onerror=function(a){e.emit("error",a)};e.emit("open",a)};w.prototype.send=function(a){a=JSON.stringify(a);if(1024<a.length){var b=a,d=b.length;a=[];for(var e=0,c=600;e<d;)a.push(b.slice(e,c)),e=c,c=e+600;b=a.length;for(d=0;b--;)a[b]=JSON.stringify({part:d++,data:a[b]})}else a=[a];b=0;for(d=a.length;b<d;b++)this.stream.write(a[b])};var v={init:{open:function(){delete this.info.pending;
this.send("init",{name:f.name,list:Object.keys(f.connections)})},end:function(a){a=JSON.parse(a);var b=l.peers[this.info.remote];p.extend(b,{name:a.name});f.emit("connection",b);f.checkNewConnections(a.list,this)},close:function(a){console.log("[closed]");console.log(a)}},register:function(a){a=JSON.parse(a);a.remote!==f.id?f.connections[a.remote].send("register",a):(f.connections[a.local]||f.connect(a.local,!1,this),f.connections[a.local][a.action](a.data))},custom:function(a){console.log("[channel doesn't exist yet - local delegation");
a=JSON.parse(a);console.log(a.action)},message:function(a){f.emit("message",a)}},r=new g,z,A=function(){r.ready=!0},E=function(a){a=JSON.parse(a.data);!a||!a.local?r.exec(a):(f.connections[a.local]||f.connect(a.local),f.connections[a.local][a.action](a.data))},K=function(a){if(a.eventPhase===EventSource.CLOSED)console.log("[close]");else throw Error(a.data);a.currentTarget.close();A()},F=function(a,b){a=JSON.stringify(a);r.add(b);s.send(a)};c.addEventListener("beforeunload",A);c.addEventListener("DOMContentLoaded",
A);var s;z={init:function(a,b){sessionStorage.id=a;s=new WebSocket("ws://localhost:2020/"+a);s.addEventListener("open",function(){F({action:"lookup",data:a},function(a){b(a)})});s.addEventListener("message",E);s.addEventListener("error",K)},send:F,handle:E};var G=function(a){if(!~a.indexOf("a=crypto")){for(var b=[],d=4;d--;)b.push(p.getToken());a+="a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:"+b.join("")+"\r\n"}~a.indexOf("b=AS")&&(a=a.replace(/b=AS:([0-9]*)/,function(){return"b=AS:1024000"}));return a},
h=function(a,b,d,e){this.info={local:a,remote:b,pending:!0};d&&(this.info.initiator=!0);e&&(this.info.transport=e);this.channels={};this.init()};h.prototype.init=function(){this.conn=new RTCPeerConnection(J,C);this.checkStateChanges();this.receiveDataChannels();this.findICECandidates();this.info.initiator&&this.createOffer()};h.prototype.checkStateChanges=function(){var a=this.conn;a.onstatechange=function(){};var b=Object.keys(v).length;a.onnegotiationneeded=function(){--b||this.createOffer()}.bind(this);
a.onicechange=function(){}};h.prototype.receiveDataChannels=function(){this.conn.ondatachannel=function(a){a=a.channel;this.channels[a.label]=new w(a,this.info.remote)}.bind(this)};h.prototype.findICECandidates=function(){this.conn.onicecandidate=function(a){a.candidate&&this.send({action:"setIceCandidates",data:a.candidate})}.bind(this)};h.prototype.setIceCandidates=function(a){var b=this.conn;if(b.remoteDescription||b.localDescription){this._candidates&&delete this._candidates;a=Array.isArray(a)?
a:[a];for(var d=0,e=a.length;d<e;d++)b.addIceCandidate(new RTCIceCandidate(a[d]))}else this._candidates||(this._candidates=[]),this._candidates.push(a)};h.prototype.createOffer=function(){var a=this.conn;a.createOffer(function(b){b.sdp=G(b.sdp);a.setLocalDescription(b,function(){this.send({action:"setConfigurations",data:b})}.bind(this))}.bind(this),m)};h.prototype.setConfigurations=function(a){var b=this.conn,d=new RTCSessionDescription(a);b.setRemoteDescription(d,function(){this._candidates&&this.setIceCandidates(this._candidates);
if("offer"===a.type)b.createAnswer(function(a){a.sdp=G(a.sdp);b.setLocalDescription(a,function(){this.send({action:"setConfigurations",data:a})}.bind(this),m)}.bind(this),null,D);else if(!Object.keys(this.channels).length)for(var d=Object.keys(v),c=0,j=d.length;c<j;c++)this.createDataChannel(d[c])}.bind(this),m)};h.prototype.createDataChannel=function(a){try{var b=this.conn.createDataChannel(a,t?{}:{reliable:!1});this.channels[a]=new w(b,this.info.remote)}catch(d){console.log("[Error] - Creating DataChannel (*)")}};
h.prototype.send=function(a,b){b||(b=a,a=null);this.info.pending?(b.local=this.info.local,b.remote=this.info.remote,this.info.transport?this.info.transport.send("register",b):z.send(b)):(this.send=function(a,b){var c=this.channels;a||(a=keys=Object.keys(c));Array.isArray(a)||(a=[a]);for(var j=0,f=a.length;j<f;j++)c[a[j]]&&c[a[j]].send(b)}.bind(this),this.send(a,b))};h.prototype.close=function(a){var b=this.channels,d=Object.keys(b);a||(a=d);Array.isArray(a)||(a=[a]);for(var d=0,c=a.length;d<c;d++)b[a[d]].close(),
delete b[a[d]]};var y=function(a){this.init(a)};p.inherits(y,k);y.prototype.init=function(a){k.call(this);this.id=a.id||null;this.name=a.name||null};l.Player=function(a){var b=function(a){a={id:p.createUID(),name:a};this.init(a);this.connections={};console.log("\n\t\t:: "+this.id+" ::\n");a=function(){z.init(this.id,function(a){a&&this.checkNewConnections([a])}.bind(this))}.bind(this);r.ready?a():r.add(a)};p.inherits(b,y);b.prototype.checkNewConnections=function(a,b){for(var c=this.connections,j=
this.id,f,g=0,h=a.length;g<h;g++)f=a[g],f!==j&&!c[f]&&this.connect(f,!0,b)};b.prototype.connect=function(a,b,c){this.connections[a]||(b=new h(this.id,a,b||!1,c),this.connections[a]=b,l.peers[a]=new y({id:a,connection:b}))};b.prototype.send=function(a,b){b||(b=a,a=null);a||(a=["message"]);Array.isArray(a)||(a=[a]);var c=this.connections,f=Object.keys(c),g,h,l,k,m;h=0;for(l=f.length;h<l;h++){g=c[f[h]];k=0;for(m=a.length;k<m;k++)g.send(a,{local:this.name,msg:b})}};return f||(f=new b(a))};l.login=function(a,
b){var c=l.Player(a.name||a);b(c)};return l});
