/**
 *	peergaming.min.js - v0.5.0 | 2013-07-23
 *	http://peergaming.net
 *	Copyright (c) 2013, Stefan DÃ¼hring
 *	MIT License
 */

(function(V,W,H){"undefined"!==typeof module?module.exports=H(W):"undefined"!==typeof define?define(V,function(){return H(W)}):W[V]=H(W)})("pg",this,function(V,W){function H(a){y(r,a);return r}function ta(a){return Object.prototype.toString.call(a).slice(8,-1)}function y(a){for(var b,c,d=1,f=arguments.length;d<f;d++)for(c in b=arguments[d],b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function N(a,b){a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})}
function Pa(a){if("object"==typeof a){for(var b=l(a),c=[],d=0,f=b.length;d<f;d++)c[d]=a[b]+"/";return c.join("")}}function ua(a){var b=[],c;b.push.apply(b,arguments);for(b.shift();a.length;)c=a.shift(),"function"===typeof c&&c.apply(c,b)}function X(a){console.warn("[ERROR] ",a);console.warn(a.name+": "+a.message);v.emit("error",{name:a.name,msg:a.message})}function Ba(a,b){var c=F[a].reference,d=l(c),f=l(b),e=[],m=[],k,p;k=0;for(p=d.length;k<p;k++)void 0==b[d[k]]&&m.push(d[k]);k=0;for(p=f.length;k<
p;k++)void 0==c[f[k]]&&e.push(f[k]);if(e.length||m.length){d=0;for(f=e.length;d<f;d++)Qa(a,b,e[d]);d=0;for(f=m.length;d<f;d++)delete c[m[d]]}setTimeout(Ba,Ca,a,b)}function Qa(a,b,c){var d=function(b){function d(b){F[a].reference[c]=b;var k=F[a].callbacks,p,f;p=0;for(f=k.length;p<f;p++)k[p].apply(k[p],[c,b]);return b}function e(a,b){a[b]=function(){Array.prototype[b].apply(this,arguments);return d(a)}}if(b!==F[a].reference[c]){if("object"===typeof b)if(Array.isArray(b))for(var k="pop push reverse shift sort splice unshift".split(" "),
p=0,O=k.length;p<O;p++)e(b,k[p]);else b=y(va(function(b,k){var p=F[a].reference[c];p[b]=k;return d(p)}),b);d(b)}};d(b[c]);Object.defineProperty(b,c,{enumerable:!0,configurable:!0,get:function(){return F[a].reference[c]},set:d})}function Da(a){if(0>a.indexOf("a=crypto")){for(var b=[],c=4;c--;)b.push(Math.random().toString(36).substr(2,10));a+="a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:"+b.join("")+"\r\n"}0<=a.indexOf("b=AS")&&(a=a.replace(/b=AS:([0-9]*)/,function(a,b){return"b=AS:"+r.handlerConfig.BANDWIDTH}));
0<=a.indexOf("a=mid:data")&&(a=a.replace(/a=mid:data\r\n/g,function(a,b){return"a=mid:data\r\nb=AS:"+r.handlerConfig.BANDWIDTH+"\r\n"}));return a}function Ea(a){var b=this._sendSDP;this._sendSDP=function(b){this.send("expectPackages",{type:"candidates",size:b});this.send("setConfigurations",a)}.bind(this);void 0!=b&&this._sendSDP(b)}function Fa(a){if(!l(a.channels).length)for(var b=l(ja),c=0,d=b.length;c<d;c++)a.createDataChannel(b[c])}function Sa(a,b,c){b={action:a,local:g.id,data:b,remote:this.info.remote};
y(b,c);c=this.ready;var d=this.channels;a||(a=l(d));Array.isArray(a)||(a=[a]);for(var f=0,e=a.length;f<e;f++)c&&d[a[f]]&&d[a[f]].send(b)}function Ta(a){if(r.reconnectConfig.restoreEnabled&&(I.id&&(a.id=I.id),I.time&&(a.time=I.time),I.data)){a=a.data;for(var b=I.data,c=l(b),d=0,e=c.length;d<e;d++)a[c[d]]=b[c[d]]}}function Ga(a,b){var c=Ha();P.player=g=new Y(a,c);b&&b(g);g.join(c)}function Ha(){var a=e.location.hash,a=a.length?a.substr(3):ka;return"/"===a.charAt(0)?a.substr(1):a}function Ia(){var a=
Ha(),b=a.split("/");Q.route=R.route=a;if(!(1>b.length))if(a=b.shift()){var c=b[0].length?"GAME":"CHANNEL";C=a="CHANNEL"===c?wa[a]||wa["*"]:la[b[0]]||la["*"];if(ma!==Q.route){if(a){if(ma){b=l(n);a=0;for(c=b.length;a<c;a++)s.disconnect(b[a]);na.send({action:"change",data:ma})}}else console.warn("[MISSING] ",c," handler doesn't exist!");ma=Q.route}}else e.location.hash="!/"+ka}function Ja(a){return function(b,c){"string"!==typeof b&&(c=b,b="*");var d=new a(b);(d instanceof J?la:wa)[b]=d;c(d);return d}}
function Z(a){this.init(a);this.match=function(a){}}function Ua(){var a=new Uint8Array(1),b,c;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){b=crypto.getRandomValues(a)[0]%16;c="x"===d?b:b&3|8;return c.toString(16)})}function D(a){xa||(xa=a)}function Ka(){S=!0;D.stop();D.resume()}function $(a,b,c){if(Va.apply(this,arguments)){var d=l(n);z[a]={list:d,results:[]};z[a].results[g.pos]=b;s.broadcast("sync",{action:"request",key:a,value:b},!0);r.synchronConfig.naiveSync||(P.sync[a]=
void 0,D.stop())}}function Va(a,b,c){if(c)z[a]&&delete z[a],aa[a]=!0,P.sync[a]=b;else if(!z[a])return aa[a]?(delete aa[a],v.emit("sync",a,b),D.resume()):!0}function Wa(a){for(var b=l(a),c,d=0,e=b.length;d<e;d++)c=b[d],$(c,a[c],!0)}function J(a){this.init(a);this.info={};this.options={minPlayer:2,maxPlayer:10};la[a]=this}function Xa(){var a;a:{a=l(t);for(var b=g.pos,c=0,d=a.length;c<d;c++)if(b-1===t[a[c]].pos){a=a[c];break a}a=void 0}a&&n[a].send("start",{request:!0},!0)}function oa(a,b){if(!a)a:{for(var c=
l(t),d=g.pos,e=0,h=c.length;e<h;e++)if(d+1===t[c[e]].pos){a=c[e];break a}a=void 0}if(l(z).length||l(aa).length)return setTimeout(oa,K,a);if(!a)return s.broadcast("start",{sync:JSON.stringify(ba),loop:!0}),setTimeout(Ka,Ca+K);n[a].send("start",{sync:JSON.stringify(ba),belated:b},!0)}var e=window,w=document,A=e.navigator,T=A.mozGetUserMedia?parseFloat(A.userAgent.match(/Firefox\/([0-9]+)\./).pop()):!1,ca=e.chrome?parseFloat(A.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./).pop()):!1,R=e.sessionStorage,
L=e.localStorage,l=Object.keys,C="",G=[],n={},pa={},na=null,s=null,S=!1,da=null,I={},q=null,Q={},v=null,g={},t={},ea=[],ba=null;e.performance?e.performance.now||(e.performance.now=e.performance.webkitNow):e.performance={now:Date().now()};if(!e.requestAnimationFrame)for(var u=["webkit","moz"],q=0,M=u.length;q<M&&!e.requestAnimationFrame;q++)e.requestAnimationFrame=e[u[q]+"RequestAnimationFrame"],e.cancelAnimationFrame=e[u[q]+"CancelAnimationFrame"]||e[u[q]+"CancelRequestAnimationFrame"];var U;if(!("hidden"in
w)){u=["webkit","moz","ms","o"];w.state&&(u.length=0);q=0;for(M=u.length;q<M;q++)u[q]+"Hidden"in w&&(w.state=w[u[q]+"VisibilityState"],w.hidden=w[u[q]+"Hidden"],U=u[q]+"visibilitychange");U||(U="visibilitychange")}e.URL||(e.URL=e.webkitURL||e.msURL||e.oURL);e.Blob||e.BlobBuilder||(e.BlobBuilder=e.BlobBuilder||e.WebKitBlobBuilder||e.MozBlobBuilder||e.MSBlobBuilder||e.OBlobBuilder);e.setImmediate||(e.setImmediate=function(){var a=[];e.addEventListener("message",function(b){"setImmediate"===b.data&&
a.shift()()},!0);return function(b){if("function"!==typeof b)throw Error("Invalid Argument");a.push(b);e.postMessage("setImmediate",e.location.href)}}());A.getUserMedia||(A.getUserMedia=(A.mozGetUserMedia||A.webkitGetUserMedia||A.msGetUserMedia).bind(A));e.AudioContext||(e.AudioContext=e.webkitAudioContext);"function"!==typeof e.RTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection||e.webkitRTCPeerConnection,e.RTCPeerConnection=function(){var a=e.RTCPeerConnection,b=ca;return function(c,
d){for(var e=c.iceServers,h,m,k,p,O=0,Ra=e.length;O<Ra;O++){h=e[O];m=null;k=h.url;p=k.split(":")[0];"stun"===p&&(m={url:k});"turn"===p&&(m=k,k=h.username,p=h.credential,m=!T||-1===m.indexOf("transport=udp")&&-1!==m.indexOf("?transport")?b?28<b?{url:m,credential:p,username:k}:{url:"turn:"+k+"@"+m.split("turn:")[1],credential:p}:void 0:{url:m.split("?")[0],credential:p,username:k},m=m||{});if(!m.url)throw Error("Invalid server address!",h,m);e[O]=m}return new a(c,d)}}());"function"!==typeof e.RTCSessionDescription&&
(e.RTCSessionDescription=e.mozRTCSessionDescription);"function"!==typeof e.RTCIceCandidate&&(e.RTCIceCandidate=e.mozRTCIceCandidate);T&&(MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]});e.webkitRTCPeerConnection&&!e.webkitRTCPeerConnection.prototype.getLocalStreams&&(e.webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},e.webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams},
e.webkitMediaStream.prototype.getVideoTracks||(e.webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},e.webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}));u=["URL","Blob","crypto","RTCPeerConnection"];q=0;for(M=u.length;q<M;q++)if(!(u[q]in e))throw Error("[MISSING FEATURE] "+u[q]);if(!e.RTCPeerConnection)return alert("Your browser doesn't support PeerConnections yet.");(function(){var a=new Uint32Array(1),b=new Uint8Array(a.buffer);a[0]=255;
return!!b[0]})();var Ya=V.pg,P=Object.create(null),q={codeName:"spicy-phoenix",full:"0.5.0",major:0,minor:5,dot:0},r={reconnectConfig:{restoreEnabled:!1,backupDuration:18E5},synchronConfig:{naiveSync:!1},handlerConfig:{BANDWIDTH:1048576,MAX_BYTES:1024,CHUNK_SIZE:600},socketConfig:{server:"ws://peergaming.net:61125"},connectionConfig:{iceServers:[{url:ca?"stun:stun.l.google.com:19302":"stun:23.21.150.121"},{url:"turn:numb.viagenie.ca",username:"demo@peergaming.net",credential:"demo"}]},connectionConstraints:{optional:[{RtpDataChannels:!0}]},
channelConfig:{reliable:!1},permissions:{audio:!0},mediaConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},optional:[]},videoConstraints:{mandatory:{maxHeight:320,maxWidth:240},optional:[{minWidth:640,minHeight:480},{minWidth:1280,minHeight:720}]}};H.noServer=function(a){"function"===typeof a&&(y(r,{connectionConfig:{iceServers:[]}}),da=a)};H.localDev=function(a){"number"!==typeof a&&(a=parseFloat(a));isNaN(a)};var La={};e.addEventListener("storage",function(a){var b=a.key;value=
a.newValue;ref=La[b];try{value=JSON.parse(value)}catch(c){console.log(c)}Array.isArray(value)||(value=[value]);"function"===typeof ref&&ref.apply(ref,value)});e.clearDebug=function(){delete L.log};e.test=function(){var a={sync:function(a,c){P.sync[a]=c}};La.test=function(b,c,d){if(a[b])a[b](c,d)};return function(b,c,d){L.test=JSON.stringify([b,c,d]);if(a[b])a[b](c,d)}}();var F=[],Ca=100,va=function(){var a=[],b=Object.create(Object.prototype);a.push.apply(a,arguments);F.push({reference:{},callbacks:a});
Ba(F.length-1,b);return b},B=function(){this._events={};return this};B.prototype.on=function(a,b,c){if("function"===typeof b){a=a.split(" ");for(var d=this._events,e=a.length,h;e--;)h=a[e],d[h]||(d[h]=[]),d[h].push([b,c]);return this}};B.prototype.once=function(a,b,c){this.on(a,function f(){this.off(a,f);b.apply(this,arguments)}.bind(this));return this};B.prototype.emit=function(a){var b=this._events[a];if(b)for(var c=Array.prototype.slice.call(arguments,1),d=b.length;d--;)b[d][0].apply(b[d][1],c||
[]);return this};B.prototype.off=function(a,b){var c=this._events,d=c[a];if(d){if(b)for(c=d.length;c--;){if(d[c]===b){d.splice(c,1);break}}else c[a].length=0;return this}};var fa=function(a){a||(a={});this.readable=a.readable;this.writable=a.writable;this.ready=!0;this.writeBuffer=[];this.readBuffer=[];B.call(this)};N(fa,B);fa.prototype.handle=function(a){a=a.data;var b=JSON.parse(a),c=this.readBuffer;if(void 0!=b.part){c.push(b.data);this.emit("data",b,c.length);if(0<b.part)return;a=c.join("");c.length=
0}this.emit("end",a)};fa.prototype.write=function(a){this.writeBuffer.push(a);this.ready&&this.emit("write",this.writeBuffer.shift());return this.ready};fa.prototype.pipe=function(a){this.on("data",function(b){a.handle(b)});return a};var x=function(a,b,c,d){this.info={local:a,remote:b,pending:!0};c&&(this.info.initiator=!0);d&&(this.info.transport=d);this._candidates=[];this._fragments={};this._counter=0;this._sendSDP=null};x.prototype.init=function(){this.conn=new RTCPeerConnection(r.connectionConfig,
r.connectionConstraints);this.checkStateChanges();this.findICECandidates();this instanceof E&&(this.channels={},this.receiveDataChannels(),this.info.initiator&&this.createOffer())};x.prototype.checkStateChanges=function(){var a=this.conn,b=l(ja).length;a.onnegotiationneeded=function(a){--b||this.createOffer()}.bind(this);a.onsignalingstatechange=function(b){b=a.signalingState;this.ready="stable"===b;"closed"===b&&(console.log("[CLOSED]"),s.disconnect(this.info.remote))}.bind(this);a.oniceconnectionstatechange=
function(a){"disconnected"===a.currentTarget.iceConnectionState&&(this.info.pending?this.closed=!0:s.disconnect(this.info.remote))}.bind(this)};x.prototype.findICECandidates=function(){function a(){var a=this._counter;this._counter=0;if(this._sendSDP)return this._sendSDP(a);this._sendSDP=a}var b=this.conn,c=4,d=!1;this.info.initiator||c--;b.onicecandidate=function(e){var h=b.iceGatheringState;e.candidate&&(this._counter++,this.send("setIceCandidates",e.candidate));if(d)--c||a.call(this);else if("complete"===
h||T)d=!0,a.call(this)}.bind(this)};x.prototype.setIceCandidates=function(a,b){if(this.closed)throw Error("Can't set ICE candidates!");if(!b)return this._candidates.push(a);for(var c=this.conn,d=a.length,e=0;e<d;e++)c.addIceCandidate(new RTCIceCandidate(a[e]));a.length=0;delete this._fragments.candidates};x.prototype.createOffer=function(){var a=this.conn;this instanceof E&&T&&Fa(this);this._sendSDP=null;a.createOffer(function(b){b.sdp=Da(b.sdp);a.setLocalDescription(b,function(){Ea.call(this,b)}.bind(this),
X)}.bind(this),X,r.mediaConstraints)};x.prototype.expectPackages=function(a){this._fragments[a.type]=a.size};x.prototype.setConfigurations=function(a){var b=this.conn,c=new RTCSessionDescription(a);if(this.closed)throw a="The underlying PeerConnection got closed too early...",v.emit("error",{msg:a,line:259}),alert("Sorry, but an error occoured. Please revisit the site!"),Error(a);if(this._candidates.length<this._fragments.candidates)return setTimeout(this.setConfigurations.bind(this),1E3,a);b.setRemoteDescription(c,
function(){this._candidates.length&&this.setIceCandidates(this._candidates,!0);this._sendSDP=null;"offer"===a.type?b.createAnswer(function(a){a.sdp=Da(a.sdp);b.setLocalDescription(a,function(){Ea.call(this,a)}.bind(this),X)}.bind(this),X,r.mediaConstraints):this instanceof E?T||Fa(this):console.log("[END] - TODO: MediaConnection cleanup + handlers")}.bind(this),T?function(){}:X)};x.prototype.close=function(a){this.conn.close()};var qa=function(a,b){var c=a.label;this.info={label:c,remote:b};this.channel=
a;this.stream=new fa({readable:!0,writable:!0});this.actions=ja[c]||ja.custom;"function"===typeof this.actions&&(this.actions={end:this.actions});a.addEventListener("open",this.init.bind(this))};qa.prototype.init=function(a){for(var b=this.channel,c=this.actions,d=this.stream,e=n[this.info.remote],h=["open","data","end","close","error"],m=0,k=h.length;m<k;m++)d.on(h[m],c[h[m]],e);d.on("write",function(a){b.send(a)});b.onmessage=d.handle.bind(d);b.onclose=function(){d.emit("close")};b.onerror=function(a){d.emit("error",
a)};d.emit("open",a)};qa.prototype.send=function(a){a=JSON.stringify(a);if(a.length>r.handlerConfig.MAX_BYTES){var b=a,c=r.handlerConfig.CHUNK_SIZE,d=b.length;a=[];for(var e=0,h=c;e<d;)a.push(b.slice(e,h)),e=h,h=e+c;b=a.length;for(c=0;b--;)a[b]=JSON.stringify({part:c++,data:a[b]})}else a=[a];b=0;for(c=a.length;b<c;b++)this.stream.write(a[b])};var ja={init:{open:function(){delete this.info.pending;this.send("init",{account:g.account,time:g.time,data:g.data,list:l(n)})},end:function(a){a=JSON.parse(a);
var b=t[this.info.remote];a=a.data;y(b.data,a.data);b.time=a.time;b.account=a.account;s.check(a.list,this);s.setup(this.info.remote)},close:function(a){s.disconnect(this.info.remote)}},register:function(a){a=JSON.parse(a);if(a.remote!==g.id)return n[a.remote]?n[a.remote].send("register",a.data,{action:a.action,local:a.local,remote:a.remote}):void 0;s.set(a,this)},ping:function(a){a=JSON.parse(a);var b=a.data;if(!b.pong)return this.send("ping",{pong:!0,index:b.index});s.setup(a.local,b.index,b.pong)},
start:function(a){function b(){if(c.sync!==JSON.stringify(ba)||l(z).length||l(aa).length||!C._start)return setTimeout(b,K);if(c.loop)return Ka();C._start()}a=JSON.parse(a);var c=a.data||{};if(c.request)return oa(a.local,!0);c.belated&&Wa(JSON.parse(c.sync));setImmediate(b)},update:function(a){a=JSON.parse(a);t[a.local].data[a.data.key]=a.data.value},sync:function(a){a=JSON.parse(a);var b=a.data;if(b.action)return Za[b.action](a.local,b.key,b.value);$(b.key,b.value,!0)},message:function(a){v.emit("message",
a)},media:function(a){a=JSON.parse(a);var b=a.data;pa[a.local]||s.share(a.local,!1);pa[a.local][b.action](b.data)},custom:function(a){a=JSON.parse(a);console.log(a.action)}},na=function(){function a(a,b){var c=new XMLHttpRequest;c.open("POST",r.socketConfig.server,!0);b&&(c.onload=function(a){c.onload=null;b(a.currentTarget.response)});c.setRequestHeader("Content-Type","text/plain; charset=UTF-8");c.send(a)}function b(){m("ws")||da||(R.id?h({action:"remove",data:R.id},function(){G.length&&(delete R.id,
ua(G))}):ua(G))}function c(a){a=JSON.parse(a.data);if(!a||!a.local)return G.length?ua(G,a):s.check(a);s.set(a)}function d(a){if(a.eventPhase===EventSource.CLOSED)return f();try{a.currentTarget.close(),b()}catch(c){console.log(c)}throw Error(a.data);}function f(){console.log("[SOCKET] - CLOSE")}function h(b,c){y(b,{local:g.id,origin:Q.route});b=JSON.stringify(b);if(m("http"))a(b,c);else{c&&G.push(c);if(da)return da(b);k.send(b)}}function m(a){return r.socketConfig.server.split(":")[0]===a}b();e.addEventListener("unload",
b);e.addEventListener("beforeunload",b);var k=null;return{init:function(a,b){R.id=a;k=new (m("http")?EventSource:WebSocket)(r.socketConfig.server+"/?local="+a+"&origin="+b);k.addEventListener("error",d);k.addEventListener("open",function(){k.addEventListener("message",c);k.addEventListener("close",f);h({action:"lookup"},function(a){s.check(a)})})},send:h,handle:c}}(),E=function(a,b,c,d){x.apply(this,arguments);this.init()};N(E,x);E.prototype.receiveDataChannels=function(){this.conn.ondatachannel=
function(a){a=a.channel;this.channels[a.label]=new qa(a,this.info.remote)}.bind(this)};E.prototype.createDataChannel=function(a){try{var b=this.conn.createDataChannel(a,r.channelConfig);this.channels[a]=new qa(b,this.info.remote)}catch(c){console.warn("[Error] - Creating DataChannel (*)")}};E.prototype.send=function(a,b,c){if(!this.info.pending)this.send=Sa.bind(this),this.send(a,b);else if(!c){c=this.info.remote;if(this.info.transport)return this.info.transport.send("register",b,{action:a,local:g.id,
remote:c});na.send({action:a,data:b,remote:c})}};E.prototype.close=function(a){var b=this.channels,c=l(b);a||(a=c);Array.isArray(a)||(a=[a]);for(var c=0,d=a.length;c<d;c++)b[a[c]].channel.close(),delete b[a[c]];l(b).length||this.conn.close()};var K=0,Ma=100,ra={},ga={},ya=null,s=function(){function a(a,b,c){for(var d=l(n),e=0,f=d.length;e<f;e++)n[d[e]].send(a,b,c)}function b(a,b){return a+b}function c(a){function b(a){setTimeout(function(){c.send("ping",{index:a},!0)},Math.random()*d)}var c=n[a],
d=Ma;a=h[a]=[d];for(var f=1;f<=d;f++)a[f]=e.performance.now(),b(f)}function d(){function a(b){ra[b.id]||(ra[b.id]=!0,v.emit("connection",b),C&&C.emit("enter",b))}var b=l(t),c=[],d;c[g.pos]=g;for(var e=0,h=b.length;e<h;e++)d=t[b[e]],c[d.pos]=d;if(b=l(ga).pop())return c=ga[b],delete ga[b],ya=null,s.check(b,c);f();e=0;for(h=c.length;e<h;e++)setTimeout(a,K,c[e])}function f(){var a=l(t),b={};b[g.time]=g.id;for(var c=0,d=a.length;c<d;c++)b[t[a[c]].time]=a[c];var e=l(b).sort(function(a,b){return a-b}).map(function(a){return b[a]});
if(e.length!==a.length+1)throw v.emit("error",{msg:"Precision time conflict",line:340}),Error("Precision time conflict");c=ea.length=0;for(d=e.length;c<d;c++)a=t[e[c]]||g,a.pos=ea.push(a.data)-1}var h={},m=0;return{broadcast:a,check:function(a,b){if(a){Array.isArray(a)||(a=[a]);var c=g.id,d;ya||(d=a.pop(),this.connect(d,!0,b));if(a.length)for(var e=0,f=a.length;e<f;e++)d=a[e],d===c||n[d]||(ga[d]=b)}},connect:function(a,b,c){n[a]||a===g.id||(ya=a,t[a]=new za({id:a}),n[a]=new E(g.id,a,b,c))},disconnect:function(a){var b=
t[a];b&&(delete ra[a],v.emit("disconnect",b),C&&C.emit("leave",b),n[a].close(),ea.splice(b.pos,1),delete t[a],delete n[a],f())},share:function(a,b,c,d){if(!pa[a]&&a!==g.id){var e=n[a];e.ready&&(pa[a]=new ha(g.id,a,b,e,c,d))}},set:function(a,b){n[a.local]||this.connect(a.local,!1,b);n[a.local][a.action](a.data)},update:function(b,c){r.reconnectConfig.restoreEnabled&&(L.player=JSON.stringify(g));a("update",{key:b,value:c},!0)},setup:function(a,f,g){if(!g)return c(a);g=h[a];g[f]=e.performance.now()-
g[f];if(!S){f=g[0];f=Ma-f;var n=l(t).length,r=l(ga).length+n;f=~~(n*f/r);f<=m||C&&C.emit("progress",m=f,r)}0<--g[0]||(g=g.reduce(b)/(g.length-1)>>1,t[a].latency=g,K=Math.max(K,g),d())}}}();y(Q,{route:null});v=new B;M=v.on.bind(v);L.player&&0<=parseFloat(JSON.parse(L.player).time)+r.reconnectConfig.backupDuration-Date.now()&&y(I,JSON.parse(L.player));delete L.player;var $a={GITHUB:function(a,b){},PERSONA:function(a,b){var c=document.createElement("script");c.addEventListener("load",function(){navigator.id.watch({loggedInUser:localStorage.user||
"",onlogin:function(a){console.log(a)},onlogout:function(){}});navigator.id.request()});c.src="https://login.persona.org/include.js";document.getElementsByTagName("script")[0].parentNode.insertBefore(c)}},ka="lobby/",ma=null,Na={},Oa={};e.addEventListener("hashchange",Ia);e.addEventListener("popstate",function(a){ca&&(ca=!ca)});var wa={},u=Ja(Z);N(Z,B);Z.prototype.init=function(a){this.id=a;B.call(this)};Z.prototype.config=function(a){y(this.options,a)};var ha=function(a,b,c,d,e,h){x.apply(this,arguments);
this.init();this.info.config=e;this.attachStream();this.info.initiator&&this.requestStream(h)};N(ha,x);ha.prototype.attachStream=function(){var a=this.conn;a.onaddstream=function(a){a=a.stream;if(eventMap[g.id].media)v.emit("media",a,this.info.remote);else{var c=new Audio;c.src=URL.createObjectURL(a);c.autoplay=!0;c.load()}}.bind(this);a.onremovestream=function(a){console.log("[MEDIA] - Removed Stream");URL.revokeObjectURL(a.stream)}.bind(this)};ha.prototype.requestStream=function(a){var b=this.info.config||
r.permissions;v.emit("permission",b);A.getUserMedia(b,function(b){this.conn.addStream(b);this.createOffer();a&&a(b)}.bind(this),function(a){console.log("[DENIED] - ",a)}.bind(this))};ha.prototype.send=function(a,b){this.info.transport.send("media",{action:a,data:b})};var za=function(a){this.init(a.id,a.account||{},a.data||{})};za.prototype.init=function(a,b,c){this.id=a;this.account=b;this.data=c;this.pos=ea.push(this.data)-1;B.call(this,a)};var Y=function(a,b){var c=Ua(),d=va(s.update);this.time=
Date.now();this.init(c,a,d);Ta(this);console.log("\n\t\t:: "+this.id+" ::\n");if(da)return setImmediate(function(){s.check(["SERVERLESS"])});d=function(){na.init(c,b)};if(!G.length)return d();G.push(d)};N(Y,za);Y.prototype.join=function(a,b){"string"!==typeof a&&(a=a.toString());"/"===a.charAt(0)&&(a=a.substr(1));var c=["!/",a,Pa(b)].join("");"/"!==c.charAt(c.length-1)&&(c+="/");if(e.location.hash===c&&c==="!/"+R.route)return Ia();e.location.hash=c};Y.prototype.send=function(a,b){b||(b=a,a=null);
"string"!==typeof b&&(b=b.toString());a||(a=l(n));Array.isArray(a)||(a=[a]);for(var c=0,d=a.length;c<d;c++)n[a[c]].send("message",{local:this.name,msg:b},!0)};var Aa={String:"list",Array:"list",Object:"config",Function:"callback"};Y.prototype.media=function(a,b,c){var d={};a&&(d[Aa[ta(a)]]=a);b&&(d[Aa[ta(b)]]=b);c&&(d[Aa[ta(c)]]=c);a=d.list;b=d.config;c=d.callback;a||(a=l(n));Array.isArray(a)||(a=[a]);for(var d=0,e=a.length;d<e;d++)s.share(a[d],!0,b,c)};var sa=!0,xa=null,ia=null;D.stop=function(){sa=
!0;ia&&(cancelAnimationFrame(ia),ia=null)};D.resume=function(){function a(){b=e.performance.now();c=b-d;d=b;f(c);sa||(ia=requestAnimationFrame(a))}if(S&&sa){sa=!1;var b=0,c=0,d=0,f=xa;ia=requestAnimationFrame(function(){d=e.performance.now();a()})}};w.addEventListener(U,function(a){a=w.title.split("[PAUSE]").pop();w.hidden||D.stop();w.title=(w.hidden?"[PAUSE] - ":"")+a});var ba=va(function(a){function b(){d=null;for(var a=l(c),b,e=0,k=a.length;e<k;e++)b=a[e],$(b,c[b]),delete c[b]}var c={},d=null;
return function(a,e){c[a]=e;d&&clearTimeout(d);d=setTimeout(b,K)}}($)),z={},aa={},Za={request:function(a,b,c){r.synchronConfig.naiveSync||D.stop();var d=z[b];void 0!=d?c=d:z[b]=c;n[a].send("sync",{action:"confirm",key:b,value:c},!0)},confirm:function(a,b,c){var d=z[b];d.results[t[a].pos]=c;d.list.length--;if(!(0<d.list.length)){a=d.results;if(r.synchronConfig.naiveSync)c=a[0];else{c=[];for(var e={},h,d=0,g=a.length;d<g;d++)h=JSON.stringify(a[d]),c.push(h),e[h]||(e[h]=0),e[h]++;for(var k=l(e),p=0,
n=[],q,d=0,g=k.length;d<g;d++)h=k[d],q=e[h],q>=p&&(q>p&&(n.length=0,p=q),n.push(h));e=c.length;d=0;for(g=n.length;d<g;d++)q=c.indexOf(n[d]),q<e&&(e=q);c=a[e]}s.broadcast("sync",{key:b,value:c},!0);$(b,c,!0)}}},la={};U=Ja(J);N(J,Z);J.prototype.start=function(a){this._start=function(){a();oa.call(this)};var b=l(ra).length;if(!(S||b<this.options.minPlayer))if(b===this.options.minPlayer){if(0===g.pos){if(!S)return this._start();oa.call(this,l(t)[0])}}else b>this.options.maxPlayer||Xa()};J.prototype.end=
function(){S=!1};J.prototype.pause=function(){};J.prototype.unpause=function(){};y(P,{noConflict:function(){V.pg=Ya;return this},VERSION:q,info:Q,config:H,watch:M,login:function(a,b,c){if(g.id)return g;"function"===typeof b&&(c=b,b=null);if(b)return b=b.toUpperCase(),$a[b]?(Ga({name:a},c),a=void 0):a=console.log("[ERROR] The chosen service is not supported yet."),a;Ga({name:a},c)},player:g,peers:t,data:ea,sync:ba,loop:D,channel:u,game:U,routes:function(a,b){b||"string"!==typeof a||(b=a,a=null);a&&
(Na={},Oa={});b&&(ka=b);return[Na,Oa,ka]}});return P});
