/**
 *	peergaming.min.js - v0.1.5 | 2013-03-11
 *	http://peergaming.net
 *	Copyright (c) 2013, Stefan DÃ¼hring
 *	MIT License
 */

(function(g,b,h){"undefined"!==typeof module?module.exports=h(b):"undefined"!==typeof define?define(g,function(){return h(b)}):b[g]=h(b)})("pg",this,function(){function g(a){for(var e,d,b=1,c=arguments.length;b<c;b++)for(d in e=arguments[b],e)e.hasOwnProperty(d)&&(a[d]=e[d]);return a}var b=window;b.performance&&!b.performance.now&&(b.performance.now=b.performance.webkitNow);b.URL||(b.URL=b.webkitURL||b.msURL||b.oURL);!b.Blob&&!b.BlobBuilder&&(b.BlobBuilder=b.BlobBuilder||b.WebKitBlobBuilder||b.MozBlobBuilder||
b.MSBlobBuilder||b.OBlobBuilder);b.RTCPeerConnection||(b.RTCPeerConnection=b.mozRTCPeerConnection||b.webkitRTCPeerConnection);navigator.getUserMedia||(navigator.getUserMedia=navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia);b.RTCSessionDescription||(b.RTCSessionDescription=b.mozRTCSessionDescription);b.RTCIceCandidate||(b.RTCIceCandidate=b.mozRTCIceCandidate);b.webkitRTCPeerConnection&&!b.webkitRTCPeerConnection.prototype.getLocalStreams&&(b.webkitRTCPeerConnection.prototype.getLocalStreams=
function(){return this.localStreams},b.webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams},b.webkitMediaStream.prototype.getVideoTracks||(b.webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},b.webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}));for(var h=!!navigator.mozGetUserMedia,j=["URL","Blob","indexedDB","RTCPeerConnection"],m=0,u=j.length;m<u;m++)j[m]in b||console.log("Missing: ",j[m]);if(!b.RTCPeerConnection)throw Error("Your browser doesn't support PeerConnections yet.");
var c=function(){};c.VERSION="0.1.5";var n=!1,l;c.queue=[];var k={};g(c,{on:function(a,e,d){a=a.split(" ");for(var b=a.length,c;b--;)c=a[b],k[c]||(k[c]=[]),k[c].push([e,d])},emit:function(a){var e=k[a];if(e)for(var d=Array.prototype.slice.call(arguments,1),b=e.length;b--;)e[b][0].apply(e[b][1],d||[])},off:function(a,e){if(e)for(var b=k[a],p=b?b.length:0;p--;){if(b[p]===e){b.splice(p,1);break}}else k[a].length=0}});g(c,{});g(c,{});c.config={server:"http://localhost:2020"};var s={iceServers:[{url:!h?
"stun:stun.l.google.com:19302":"stun:23.21.150.121"}]},v={optional:[{RtpDataChannels:!0}]},t={optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}};h&&(t.mandatory.MozDontOfferDataChannel=!0);var s=null,q,r=function(a,e){var b=new XMLHttpRequest;b.open("POST",c.config.server,!0);e&&(b.onload=function(a){b.onload=null;e(a.currentTarget.response)});b.setRequestHeader("Content-Type","text/plain; charset=UTF-8");b.send(JSON.stringify(a))},j=function(){if(sessionStorage.id)r({action:"remove",
data:sessionStorage.id},function(){if(!n&&(delete sessionStorage.id,n=!0,c.queue.length))for(var a=0,e=c.queue.length;a<e;a++)c.queue[a]()});else if(n=!0,c.queue.length)for(var a=0,e=c.queue.length;a<e;a++)c.queue[a]()},w=function(a){a=JSON.parse(a.data);if(l.connections[a.local])l.connections[a.local][a.action](a.data);else l.connect(a.local,a.data)},x=function(a){if(a.eventPhase===EventSource.CLOSED)console.log("[close]");else throw Error(a.data);a.currentTarget.close()};b.addEventListener("beforeunload",
j);b.addEventListener("DOMContentLoaded",j);q={init:function(a,e){var b={action:"register",data:a};sessionStorage.id=a;r(b,function(b){var d;try{d=new EventSource(c.config.server+"/"+a),d.addEventListener("open",function(){e(b)}),d.addEventListener("message",w),d.addEventListener("error",x)}catch(f){console.log(f)}})},send:function(a){r(a)}};var f=function(a,b,d){this.localID=a;this.remoteID=b;this.input=d;this.channels={};this.conn=new RTCPeerConnection(s,v);this.attachMediaStreams()};f.prototype.init=
function(){var a=this.input;a?a.candidate?(console.log("[input - candidate]"),this.setIceCandidates(a)):(console.log("[input - offer]"),this.setConfigurations(a)):this.createOffer();this.receiveDataChannel();this.findICECandidates()};f.prototype.handleChanges=function(){this.conn.onnegotiationneeded=function(){console.log("[negotiation needed]");this.createOffer()}.bind(this)};f.prototype.attachMediaStreams=function(){var a=this.conn;a.onaddstream=function(a){console.log("[added stream]");var b=document.createElement("video");
b.src=URL.createObjectURL(a.stream);b.autoplay=!0;a=document.createElement("div");a.textContent=this.remoteID;a.className="name";a.appendChild(b);document.body.appendChild(a)}.bind(this);a.onremovestream=function(){console.log("[removed stream]")};navigator.getUserMedia({audio:!0,video:!0},function(b){a.addStream(b);this.init()}.bind(this))};f.prototype.receiveDataChannel=function(){this.conn.ondatachannel=function(a){console.log("[remote channel]");a=a.channel;a.onopen=function(a){console.log("[opened channel]");
console.log(a)};a.onmessage=function(a){console.log("[message]");console.log(a);console.log(a.data)};a.onclose=function(a){console.log("[closed channel]");console.log(a)};this.channel=a;c.emit("connection",a)}.bind(this)};f.prototype.createDataChannel=function(a){var b=this.conn.createDataChannel(a,h?{}:{reliable:!1});b.onopen=function(d){console.log("[open channel]");console.log(d);b.onmessage=function(a){console.log("[message]");console.log(a);console.log(a.data)};b.onclose=function(a){console.log("[close]");
console.log(a)};b.onerror=function(a){console.log("[error]");console.log(a)};this.channels[a]=b;c.emit("connection",b)}.bind(this)};f.prototype.findICECandidates=function(){this.conn.onicecandidate=function(a){a.candidate&&this.send({action:"setIceCandidates",data:a.candidate})}.bind(this)};f.prototype.createOffer=function(){var a=this.conn;a.createOffer(function(b){a.setLocalDescription(b,function(){console.log("[created offer]");this.send({action:"setConfigurations",data:b})}.bind(this))}.bind(this),
function(a){console.log(a)})};f.prototype.setIceCandidates=function(a){var b=this.conn;if(b.remoteDescription||b.localDescription){this._candidates&&delete this._candidates;a=Array.isArray(a)?a:[a];for(var d=0,c=a.length;d<c;d++)b.addIceCandidate(new RTCIceCandidate(a[d]))}else this._candidates||(this._candidates=[]),this._candidates.push(a)};f.prototype.setConfigurations=function(a){console.log("[Description | SDP - "+a.type+" ]");var b=this.conn,d=new RTCSessionDescription(a);b.setRemoteDescription(d,
function(){this._candidates&&this.setIceCandidates(this._candidates);"offer"===a.type&&b.createAnswer(function(a){b.setLocalDescription(a,function(){this.send({action:"setConfigurations",data:a})}.bind(this),function(a){console.log(a)})}.bind(this),null,t)}.bind(this),function(a){console.log(a)})};f.prototype.send=function(a){a.local=this.localID;a.remote=this.remoteID;q.send(a)};f.prototype.close=function(){for(var a=this.channels,b=Object.keys(a),d=0,c=b.length;d<c;d++)a[b[d]].close(),delete a[b[d]]};
c.Peer=function(a){var b=function(a){this.id=this.name=a;this.stores={};this.connections={};a=function(){q.init(this.id,function(a){a&&this.connect(a)}.bind(this))}.bind(this);n?a():c.queue.push(a)};b.prototype.connect=function(a,b){this.connections[a]||(console.log('connect to "'+a+'"'),this.connections[a]=new f(this.id,a,b))};return l||(l=new b(a))};g(c,{});g(c,{});return c});
