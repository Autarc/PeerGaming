/**
 *	peergaming.min.js - v0.1.7 | 2013-03-16
 *	http://peergaming.net
 *	Copyright (c) 2013, Stefan DÃ¼hring
 *	MIT License
 */

(function(r,c,n){"undefined"!==typeof module?module.exports=n(c):"undefined"!==typeof define?define(r,function(){return n(c)}):c[r]=n(c)})("pg",this,function(){function r(a){console.log("[error]");console.log(a,a.name+": "+a.message)}var c=window;c.performance?c.performance.now||(c.performance.now=c.performance.webkitNow):c.performance={now:Date().now()};c.URL||(c.URL=c.webkitURL||c.msURL||c.oURL);!c.Blob&&!c.BlobBuilder&&(c.BlobBuilder=c.BlobBuilder||c.WebKitBlobBuilder||c.MozBlobBuilder||c.MSBlobBuilder||
c.OBlobBuilder);c.RTCPeerConnection||(c.RTCPeerConnection=c.mozRTCPeerConnection||c.webkitRTCPeerConnection);navigator.getUserMedia||(navigator.getUserMedia=navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia);c.RTCSessionDescription||(c.RTCSessionDescription=c.mozRTCSessionDescription);c.RTCIceCandidate||(c.RTCIceCandidate=c.mozRTCIceCandidate);c.webkitRTCPeerConnection&&!c.webkitRTCPeerConnection.prototype.getLocalStreams&&(c.webkitRTCPeerConnection.prototype.getLocalStreams=
function(){return this.localStreams},c.webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams},c.webkitMediaStream.prototype.getVideoTracks||(c.webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},c.webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}));for(var n=!!navigator.mozGetUserMedia,p=["URL","Blob","indexedDB","RTCPeerConnection"],w=0,C=p.length;w<C;w++)p[w]in c||console.log("Missing: ",p[w]);if(!c.RTCPeerConnection)throw Error("Your browser doesn't support PeerConnections yet.");
c.clearDebug=function(){delete localStorage.log};var j=function(){};j.VERSION="0.1.7";j.peers={};var f,q={extend:function(a){for(var b,d,l=1,c=arguments.length;l<c;l++)for(d in b=arguments[l],b)b.hasOwnProperty(d)&&(a[d]=b[d]);return a},inherits:function(a,b){a.prototype=Object.create(b.prototype)},createUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)})}};q.extend(q,function(){var a={};return{on:function(b,
d,l){b=b.split(" ");for(var c=b.length,f;c--;)f=b[c],a[f]||(a[f]=[]),a[f].push([d,l])},emit:function(b){var d=a[b];if(d)for(var l=Array.prototype.slice.call(arguments,1),c=d.length;c--;)d[c][0].apply(d[c][1],l||[])},off:function(b,d){if(d)for(var l=a[b],c=l?l.length:0;c--;){if(l[c]===d){l.splice(c,1);break}}else a[b].length=0}}}());p=function(){this.ready=!1;this.list=[]};p.prototype.add=function(a){"function"===typeof a&&this.list.push(a)};p.prototype.exec=function(){this.ready=!0;for(var a=Array.prototype.slice.call(arguments),
b=this.list;b.length;)b.pop().apply(null,a)};var h={channelConfig:{MAX_BYTES:1024,CHUNK_SIZE:600,CHUNK_DELAY:400},socketConfig:{server:"ws://localhost:2020"},peerConfig:{iceServers:[{url:!n?"stun:stun.l.google.com:19302":"stun:23.21.150.121"}]},connectionConstraints:{optional:[{RtpDataChannels:!0}]},mediaConstraints:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}};n&&(h.mediaConstraints.mandatory.MozDontOfferDataChannel=!0,h.connectionConstraints.optional[0].DtlsSrtpKeyAgreement=
!0);var s=function(a,b){this.remoteID=a;this.connection=f.connections[this.remoteID];if(b){b.message||(b={message:b});for(var d=Object.keys(b),c=0,D=d.length;c<D;c++)this["_"+d[c]]=b[d[c]]}};s.prototype.open=function(a){var b=a.currentTarget;this.name=b.label;b.addEventListener("message",this.message.bind(this));b.addEventListener("close",this.close.bind(this));b.addEventListener("error",this.error.bind(this));this.connection.channels[this.name]=b;this._open&&this._open.call(this.connection,a)};s.prototype.message=
function(a){this._message&&this._message.call(this.connection,a)};s.prototype.error=function(a){console.log("[channel - error]");this._error&&this._error.call(this.connection,a)};s.prototype.close=function(){console.log("[channel - closed]");this._close&&this._close.call(this.connection,e)};var t={message:function(a){console.log(a)}},k={},u={init:{open:function(){var a={name:f.name,list:Object.keys(f.connections)};this.send("init",a)},message:function(a){a=JSON.parse(a.data);var b=j.peers[this.remoteID];
q.extend(b,{name:a.name});f.checkNewConnections(a.list,this);q.emit("connection",b)}},chunk:function(a){a=JSON.parse(a.data);var b=this.channels.chunk,d=a.id;if(!a.data&&!a.size)setTimeout(function(){b.send(JSON.stringify({id:d,data:k[d].pop()}))},h.channelConfig.CHUNK_DELAY);else if(k[d])if(k[d].chunks.push(a.data),k[d].chunks.length!==k[d].size)a=k[d].chunks.length,b.send(JSON.stringify({id:d,part:a}));else if(a=k[d].chunks.join(""),a=JSON.parse(a),delete k[d],t[a.action])t[a.action](a.data);else u.register({data:JSON.stringify(a)});
else k[d]={size:a.size,chunks:[]},a=k[d].chunks.length,b.send(JSON.stringify({id:d,part:a}))},register:function(a){a=JSON.parse(a.data);f.connections[a.remote]?f.connections[a.remote].send("register",a):a.remote===f.id&&(f.connections[a.local]||f.connect(a.local,!1,this),f.connections[a.local][a.action](a.data))},delegate:function(a){var b=JSON.parse(a.data);if(t[b.action])t[b.action](b.data,a)}},m=new p,x,z=function(){"http"!==h.socketConfig.server.split(":")[0]?m.ready=!0:sessionStorage.id?y({action:"remove",
data:sessionStorage.id},function(){m.ready||(delete sessionStorage.id,m.exec())}):m.exec()},B=function(a){a=JSON.parse(a.data);!a||!a.local?m.exec(a):(f.connections[a.local]||f.connect(a.local),f.connections[a.local][a.action](a.data))},E=function(a){if(a.eventPhase===EventSource.CLOSED)console.log("[close]");else throw Error(a.data);a.currentTarget.close();z()},y=function(a,b){a=JSON.stringify(a);if("http"===h.socketConfig.server.split(":")[0]){var d=a,c=new XMLHttpRequest;c.open("POST",h.socketConfig.server,
!0);b&&(c.onload=function(a){c.onload=null;b(a.currentTarget.response)});c.setRequestHeader("Content-Type","text/plain; charset=UTF-8");c.send(d)}else m.add(b),v.send(a)};c.addEventListener("beforeunload",z);c.addEventListener("DOMContentLoaded",z);var v;x={init:function(a,b){sessionStorage.id=a;v="http"===h.socketConfig.server.split(":")[0]?new EventSource(h.socketConfig.server+"/"+a):new WebSocket(h.socketConfig.server+"/"+a);v.addEventListener("open",function(){y({action:"lookup",data:a},function(a){b(a)})});
v.addEventListener("message",B);v.addEventListener("error",E)},send:y,handle:B};var F=function(a,b){for(var d=h.channelConfig.CHUNK_SIZE,c=b.length,f=[],g=0,A=d;g<c;)f.push(b.slice(g,A)),g=A,A=g+d;d=Date.now();k[d]=f.reverse();this.send("chunk",{id:d,size:f.length})},g=function(a,b,d,c){this.localID=a;this.remoteID=b;this.initiator=d;this.transport=c;this.channels={};this.conn=new RTCPeerConnection(h.peerConfig,h.connectionConstraints);this.init()};g.prototype.init=function(){this.initiator&&this.createOffer();
this.detectChanges();this.receiveDataChannels();this.findICECandidates();this.SDP&&(this.setConfigurations(this.SDP),delete this.SDP)};g.prototype.attachMediaStreams=function(){var a=this.conn;a.onaddstream=function(){console.log("[added stream]")}.bind(this);a.onremovestream=function(){console.log("[removed stream]")};navigator.getUserMedia({audio:!0,video:!0},function(b){this.stream=b;a.addStream(b);this.init()}.bind(this))};g.prototype.detectChanges=function(){var a=this.conn,b=Object.keys(u).length;
a.onnegotiationneeded=function(){--b||this.createOffer()}.bind(this);a.onstatechange=function(){};a.onicechange=function(){}};g.prototype.receiveDataChannels=function(){this.conn.ondatachannel=function(a){a=a.channel;var b=new s(this.remoteID,u[a.label]);a.onopen=b.open.bind(b)}.bind(this)};g.prototype.createDataChannel=function(a,b){b&&(t[a]=b);try{var d=this.conn.createDataChannel(a,n?{}:{reliable:!1}),c=new s(this.remoteID,u[a]);d.onopen=c.open.bind(c)}catch(f){console.log("[Error] - Creating DataChannel (*)")}};
g.prototype.findICECandidates=function(){this.conn.onicecandidate=function(a){a.candidate&&this.send({action:"setIceCandidates",data:a.candidate})}.bind(this)};g.prototype.createOffer=function(){var a=this.conn;a.createOffer(function(b){a.setLocalDescription(b,function(){this.send({action:"setConfigurations",data:b})}.bind(this))}.bind(this),r)};g.prototype.setIceCandidates=function(a){var b=this.conn;if(b.remoteDescription)if(this.test)this._candidates||(this._candidates=[]),this._candidates.push(a);
else{this.test=1;this._candidates&&delete this._candidates;a=Array.isArray(a)?a:[a];for(var d=0,c=a.length;d<c;d++)b.addIceCandidate(new RTCIceCandidate(a[d]))}else this._candidates||(this._candidates=[]),this._candidates.push(a)};g.prototype.setConfigurations=function(a){var b=this.conn,d=new RTCSessionDescription(a);b.setRemoteDescription(d,function(){delete this.test;this._candidates&&this.setIceCandidates(this._candidates);if("offer"===a.type)b.createAnswer(function(a){b.setLocalDescription(a,
function(){this.send({action:"setConfigurations",data:a})}.bind(this),r)}.bind(this),null,h.mediaConstraints);else if(this.created)delete this.created;else{this.created=!0;for(var d=Object.keys(u),c=0,f=d.length;c<f;c++)this.createDataChannel(d[c])}}.bind(this),r)};g.prototype.send=function(a,b){b||(b=a,a=null);var d=this.channels,c=Object.keys(d);if(c.length)if(b=JSON.stringify(b),b.length<h.channelConfig.MAX_BYTES){a||(a=c);Array.isArray(a)||(a=[a]);for(var c=0,f=a.length;c<f;c++)d[a[c]].send(b)}else F.apply(this,
[a,b]);else b.local=this.localID,b.remote=this.remoteID,this.transport?this.transport.send("register",b):x.send(b)};g.prototype.close=function(a){var b=this.channels,c=Object.keys(b);a||(a=c);Array.isArray(a)||(a=[a]);for(var c=0,f=a.length;c<f;c++)b[a[c]].close(),delete b[a[c]]};c=function(a){this.init(a)};c.prototype.init=function(a){this.id=a.id||null;this.name=a.name||null;this.connection=a.connection||null};j.Peer=c;j.Player=function(a){q.extend(h,j.config);var b=function(a){this.id=q.createUID();
this.name=a;this.stores={};this.connections={};console.log("\n\t\t:: "+this.id+" ::\n");a=function(){x.init(this.id,function(a){a&&this.checkNewConnections([a])}.bind(this))}.bind(this);m.ready?a():m.add(a)};b.prototype.checkNewConnections=function(a,b){for(var c=this.connections,g=this.id,h,j=0,k=a.length;j<k;j++)h=a[j],h!==g&&!c[h]&&f.connect(h,!0,b)};b.prototype.connect=function(a,b,c){this.connections[a]||(b=new g(this.id,a,b||!1,c),this.connections[a]=b,j.peers[a]=new j.Peer({id:a,connection:b}))};
b.prototype.on=q.on;b.prototype.send=function(a,b){b||(b=a,a=null);a||(a=["message"]);Array.isArray(a)||(a=[a]);var c=this.connections,f=Object.keys(c),h,g,j,k,m;g=0;for(j=f.length;g<j;g++){h=c[f[g]];k=0;for(m=a.length;k<m;k++)h.send("delegate",{action:a[k],data:b})}};return f||(f=new b(a))};j.login=function(a,b){var c=j.Player(a.name||a);b(c)};return j});
