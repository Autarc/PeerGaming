/**
 *	peergaming.min.js - v0.3.1 | 2013-05-18
 *	http://peergaming.net
 *	Copyright (c) 2013, Stefan DÃ¼hring
 *	MIT License
 */

(function(y,n,v){"undefined"!==typeof module?module.exports=v(n):"undefined"!==typeof define?define(y,function(){return v(n)}):n[y]=v(n)})("pg",this,function(y){function n(a){console.log("[error]");console.log(a,a.name+": "+a.message)}function v(a,b){var c=w[a].reference,e=O(c),d=O(b),p=[],C=[],f,g;f=0;for(g=e.length;f<g;f++)b[e[f]]||C.push(e[f]);f=0;for(g=d.length;f<g;f++)c[d[f]]||p.push(d[f]);if(p.length||C.length){e=0;for(d=p.length;e<d;e++)X(a,b,p[e]);e=0;for(d=C.length;e<d;e++)delete c[C[e]]}setTimeout(v,
Y,a,b)}function X(a,b,c){var e=function(b){w[a].reference[c]=b;var e=w[a].callbacks,d,f;d=0;for(f=e.length;d<f;d++)e[d].apply(e[d],[c,b]);return b};e(b[c]);Object.defineProperty(b,c,{enumerable:!0,configurable:!0,get:function(){return w[a].reference[c]},set:e})}function P(a){if(!~a.indexOf("a=crypto")){for(var b=[],c=4;c--;)b.push(j.getToken());a+="a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:"+b.join("")+"\r\n"}~a.indexOf("b=AS")&&(a=a.replace(/b=AS:([0-9]*)/,function(){return"b=AS:"+k.channelConfig.BANDWIDTH}));
return a}function Q(){var a=d.location.hash.substr(3),b=a.split("/");s.currentRoute=a;if(!(1>b.length))if(a=b.shift())if(a=!b[0].length?H[a]||H["*"]:I[a]||I["*"])a.call(a,b);else throw Error("Missing channel/game handler !");else d.location.hash="!/"+D.substr(1)}var d=window,R=!!navigator.mozGetUserMedia,s=d.sessionStorage,f,Y=100;d.performance?d.performance.now||(d.performance.now=d.performance.webkitNow):d.performance={now:Date().now()};if(!d.requestAnimationFrame)for(var q=["webkit","moz"],g=0,
J=q.length;g<J&&!d.requestAnimationFrame;g++)d.requestAnimationFrame=d[q[g]+"RequestAnimationFrame"],d.cancelAnimationFrame=d[q[g]+"CancelAnimationFrame"]||d[q[g]+"CancelRequestAnimationFrame"];d.URL||(d.URL=d.webkitURL||d.msURL||d.oURL);!d.Blob&&!d.BlobBuilder&&(d.BlobBuilder=d.BlobBuilder||d.WebKitBlobBuilder||d.MozBlobBuilder||d.MSBlobBuilder||d.OBlobBuilder);if(!d.setImmediate){var g=d,S=[];d.addEventListener("message",function(){S.shift()()},!0);g.setImmediate=function(a){if("function"!==typeof a)throw Error("Invalid Argument");
S.push(a);d.postMessage("setImmediate","*")}}navigator.getUserMedia||(navigator.getUserMedia=navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia);"function"!==typeof d.RTCPeerConnection&&(d.RTCPeerConnection=d.mozRTCPeerConnection||d.webkitRTCPeerConnection);"function"!==typeof d.RTCSessionDescription&&(d.RTCSessionDescription=d.mozRTCSessionDescription);"function"!==typeof d.RTCIceCandidate&&(d.RTCIceCandidate=d.mozRTCIceCandidate);d.webkitRTCPeerConnection&&!d.webkitRTCPeerConnection.prototype.getLocalStreams&&
(d.webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},d.webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams},d.webkitMediaStream.prototype.getVideoTracks||(d.webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},d.webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}));q=["URL","Blob","crypto","indexedDB","RTCPeerConnection"];g=0;for(J=q.length;g<J;g++)q[g]in d||console.log("Missing: ",
q[g]);if(!d.RTCPeerConnection)throw Error("Your browser doesn't support PeerConnections yet.");g=new Uint32Array(1);new Uint8Array(g.buffer);g[0]=255;d.clearDebug=function(){delete localStorage.log};var Z=y.pg,h=Object.create(null);h.VERSION={codeName:"salty-goblin",full:"0.3.1",major:0,minor:3,dot:1};h.noConflict=function(){y.pg=Z;return this};var k={channelConfig:{BANDWIDTH:1048576,MAX_BYTES:1024,CHUNK_SIZE:600},socketConfig:{server:"ws://peergaming.dev:61125"},peerConfig:{iceServers:[{url:!R?"stun:stun.l.google.com:19302":
"stun:23.21.150.121"}]},connectionConstraints:{optional:[{RtpDataChannels:!0}]},mediaConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},optional:[]},videoConstraints:{mandatory:{maxHeight:320,maxWidth:240},optional:[]}};h.config=function(a){j.extend(k,a);return k};var j={check:function(a){return Object.prototype.toString.call(a).slice(8,-1)},extend:function(a){for(var b,c,e=1,d=arguments.length;e<d;e++)for(c in b=arguments[e],b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},inherits:function(a,
b){a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})},getToken:function(){return Math.random().toString(36).substr(2,10)},createUID:function(){var a=new Uint8Array(1),b,c;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){b=crypto.getRandomValues(a)[0]%16;c="x"===e?b:b&3|8;return c.toString(16)})},StringToBuffer:function(a){for(var b=new ArrayBuffer(2*a.length),c=new Uint16Array(b),e=0,d=a.length;e<d;e++)c[e]=a.charCodeAt(e);
return b},BufferToString:function(a){return String.fromCharCode.apply(null,new Uint16Array(a))},createQuery:function(a){if("object"==typeof a){for(var b=Object.keys(a),c=[],e=0,d=b.length;e<d;e++)c[e]=a[b]+"/";return c.join("")}}},w=[],$=function(){var a=[],b=Object.create(Object.prototype);a.push.apply(a,arguments);w.push({reference:{},callbacks:a});v(w.length-1,b);return b},O=Object.keys,g=function(){this.ready=!1;this.list=[]};g.prototype.add=function(a){"function"===typeof a&&this.list.push(a)};
g.prototype.exec=function(){this.ready=!0;for(var a=Array.prototype.slice.call(arguments),b=this.list;b.length;)b.pop().apply(null,a)};g.prototype.clear=function(){this.list.length=0};var l=function(){this._events={};return this};l.prototype.on=function(a,b,c){if("function"===typeof b){a=a.split(" ");for(var e=this._events,d=a.length,f;d--;)f=a[d],e[f]||(e[f]=[]),e[f].push([b,c]);return this}};l.prototype.once=function(a,b){this.on(a,function e(){this.off(a,e);b.apply(this,arguments)}.bind(this));
return this};l.prototype.emit=function(a){var b=this._events[a];if(b)for(var c=Array.prototype.slice.call(arguments,1),e=b.length;e--;)b[e][0].apply(b[e][1],c||[]);return this};l.prototype.off=function(a,b){var c=this._events,e=c[a];if(e){if(b)for(c=e.length;c--;){if(e[c]===b){e.splice(c,1);break}}else c[a].length=0;return this}};var z=function(a){l.call(this);a||(a={});this.writeable=this.readable=a.readable;this.ready=!0;this.writeBuffer=[];this.readBuffer=[]};j.inherits(z,l);z.prototype.handle=
function(a){a=a.data;var b=JSON.parse(a),c=this.readBuffer;if(void 0!==b.part){c.push(b.data);this.emit("data",b,c.length);if(0<b.part)return;a=c.join("");c.length=0}this.emit("end",a)};z.prototype.write=function(a){this.writeBuffer.push(a);this.ready&&this.emit("write",this.writeBuffer.shift());return this.ready};z.prototype.pipe=function(a){this.on("data",function(b){a.handle(b)});return a};var F=function(a,b){var c=a.label;this.info={label:c,remote:b};this.channel=a;this.stream=new z({readable:!0,
writeable:!0});this.actions=E[c]||E.custom;"function"===typeof this.actions&&(this.actions={end:this.actions});a.addEventListener("open",this.init.bind(this))};F.prototype.init=function(a){for(var b=this.channel,c=this.actions,e=this.stream,d=f.connections[this.info.remote],p=["open","data","end","close","error"],g=0,h=p.length;g<h;g++)e.on(p[g],c[p[g]],d);e.on("write",function(a){b.send(a)});b.onmessage=e.handle.bind(e);b.onclose=function(){e.emit("close")};b.onerror=function(a){e.emit("error",a)};
e.emit("open",a)};F.prototype.send=function(a){a=JSON.stringify(a);if(a.length>k.channelConfig.MAX_BYTES){var b=a,c=k.channelConfig.CHUNK_SIZE,e=b.length;a=[];for(var d=0,f=c;d<e;)a.push(b.slice(d,f)),d=f,f=d+c;b=a.length;for(c=0;b--;)a[b]=JSON.stringify({part:c++,data:a[b]})}else a=[a];b=0;for(c=a.length;b<c;b++)this.stream.write(a[b])};var E={init:{open:function(){delete this.info.pending;this.send("init",{name:f.account.name,list:Object.keys(f.connections)})},end:function(a){a=JSON.parse(a);var b=
h.peers[this.info.remote];a=a.data;j.extend(b,{account:{name:a.name}});f.emit("connection",b);f.checkNewConnections(a.list,this)},close:function(a){console.log("[closed]");console.log(a)}},register:function(a){a=JSON.parse(a);if(a.remote!==f.id)return f.connections[a.remote].send("register",a.data,{action:a.action,local:a.local,remote:a.remote});f.connections[a.local]||f.connect(a.local,!1,this);f.connections[a.local][a.action](a.data)},custom:function(a){console.log("[channel doesn't exist yet - local delegation");
a=JSON.parse(a);console.log(a.action)},message:function(a){f.emit("message",a)}},r=new g,K,G=function(){L("ws")?r.ready=!0:s.id?M({action:"remove",data:s.id},function(){r.ready||(delete s.id,r.exec())}):r.exec()},T=function(a){a=JSON.parse(a.data);if(!a||!a.local)return r.exec(a);f.connections[a.local]||f.connect(a.local);f.connections[a.local][a.action](a.data)},aa=function(a){if(a.eventPhase===EventSource.CLOSED)console.log("[socket - close]");else throw Error(a.data);a.currentTarget.close();G()},
ba=function(){console.log("[closed]")},M=function(a,b){j.extend(a,{local:f.id,origin:s.currentRoute});a=JSON.stringify(a);if(L("http")){var c=a,e=new XMLHttpRequest;e.open("POST",k.socketConfig.server,!0);b&&(e.onload=function(a){e.onload=null;b(a.currentTarget.response)});e.setRequestHeader("Content-Type","text/plain; charset=UTF-8");e.send(c)}else r.add(b),x.send(a)},L=function(a){return k.socketConfig.server.split(":")[0]===a};G();d.addEventListener("unload",G);d.addEventListener("beforeunload",
G);var x;K={init:function(a,b,c){s.id=a;x=new (L("http")?EventSource:WebSocket)(k.socketConfig.server+"/?local="+a+"&origin="+b);x.addEventListener("open",function(){x.addEventListener("message",T);x.addEventListener("error",aa);x.addEventListener("close",ba);M({action:"lookup"},function(a){c(a)})})},send:M,handle:T};var m=function(a,b,c,e){this.info={local:a,remote:b,pending:!0};c&&(this.info.initiator=!0);e&&(this.info.transport=e);this.channels={};this.init()};m.prototype.init=function(){this.conn=
new RTCPeerConnection(k.peerConfig,k.connectionConstraints);this.checkStateChanges();this.receiveDataChannels();this.findICECandidates();this.info.initiator&&this.createOffer()};m.prototype.checkStateChanges=function(){var a=this.conn,b=Object.keys(E).length;a.onnegotiationneeded=function(){--b||this.createOffer()}.bind(this);a.oniceconnectionstatechange=function(a){"disconnected"===a.currentTarget.iceConnectionState&&h.peers[this.info.remote].remove()}.bind(this);a.onsignalingstatechange=function(){}.bind(this)};
m.prototype.receiveDataChannels=function(){this.conn.ondatachannel=function(a){a=a.channel;this.channels[a.label]=new F(a,this.info.remote)}.bind(this)};m.prototype.findICECandidates=function(){this.conn.onicecandidate=function(a){a.candidate&&this.send("setIceCandidates",a.candidate)}.bind(this)};m.prototype.setIceCandidates=function(a){var b=this.conn;if(b.remoteDescription||b.localDescription){this._candidates&&delete this._candidates;a=Array.isArray(a)?a:[a];for(var c=0,e=a.length;c<e;c++)b.addIceCandidate(new RTCIceCandidate(a[c]))}else this._candidates||
(this._candidates=[]),this._candidates.push(a)};m.prototype.createOffer=function(){var a=this.conn;R&&a.createDataChannel("[moz]");a.createOffer(function(b){b.sdp=P(b.sdp);a.setLocalDescription(b,function(){this.send("setConfigurations",b)}.bind(this))}.bind(this),n,k.mediaConstraints)};m.prototype.setConfigurations=function(a){var b=this.conn,c=new RTCSessionDescription(a);b.setRemoteDescription(c,function(){this._candidates&&this.setIceCandidates(this._candidates);if("offer"===a.type)b.createAnswer(function(a){a.sdp=
P(a.sdp);b.setLocalDescription(a,function(){this.send("setConfigurations",a)}.bind(this),n)}.bind(this),null,k.mediaConstraints);else if(!Object.keys(this.channels).length)for(var c=Object.keys(E),d=0,f=c.length;d<f;d++)this.createDataChannel(c[d])}.bind(this),n)};m.prototype.createDataChannel=function(a){try{var b=this.conn.createDataChannel(a,{reliable:!1});this.channels[a]=new F(b,this.info.remote)}catch(c){console.log("[Error] - Creating DataChannel (*)")}};m.prototype.send=function(a,b){if(this.info.pending){var c=
this.info.remote;if(this.info.transport)return this.info.transport.send("register",b,{action:a,local:f.id,remote:c});K.send({action:a,data:b,remote:c})}else this.send=function(a,b,c){b={action:a,local:f.id,data:b,remote:this.info.remote};j.extend(b,c);c=this.channels;a||(a=keys=Object.keys(c));Array.isArray(a)||(a=[a]);for(var d=0,g=a.length;d<g;d++)c[a[d]]&&c[a[d]].send(b)}.bind(this),this.send(a,b)};m.prototype.close=function(a){var b=this.channels,c=Object.keys(b);a||(a=c);Array.isArray(a)||(a=
[a]);for(var c=0,d=a.length;c<d;c++)b[a[c]].close(),delete b[a[c]]};var ca=function(a,b){console.log("[changed] "+a+": "+b)};h.info={note:"ToDo"};h.login=function(a,b,c){"function"===typeof b&&(c=b);a={name:a};b=d.location.hash.substr(3)||D.substr(1);h.player=f=new t(a,b);c&&c(f);f.join(b)};var U={},V={},D="/lobby/";h.routes=function(a,b){!b&&"string"===typeof a&&(b=a,a=null);a&&(U={},V={});b&&(D=b);return[U,V,D]};d.addEventListener("hashchange",Q);var H={},N=function(a){l.call(this);this.id=a};j.inherits(N,
l);h.channel=function(a,b){"string"!==typeof a&&(b=a,a="*");var c=new N(a),d=b;H[a]=function(a){d(c,a);c.emit("enter",f)};return c};var I={},u=function(a){l.call(this);this.id=a;this.config={minPlayer:2,maxPlayer:8}};j.inherits(u,N);u.prototype.info=function(){return{currentPlayers:2,state:"running"}};u.prototype.start=function(){};u.prototype.end=function(){};u.prototype.pause=function(){};u.prototype.unpause=function(){};h.game=function(a,b){"string"!==typeof a&&(b=a,a="*");var c=new u(a),d=b;I[a]=
function(a){d(c,a);c.emit("enter",f)};return c};h.peers={};h.data=[];var W={},A=function(a){this.init(a.id,a.account)};j.inherits(A,l);A.prototype.init=function(a,b){l.call(this);this.id=a;this.account=b;this.data||(this.data={});W[this.id]=h.data.push(this.data)-1};A.prototype.remove=function(){var a=this.id;h.data.splice(W[a],1);f.emit("disconnect",this);delete h.peers[a];delete f.connections[a]};var B={};h.player={on:function(a,b,c){B[a]||(B[a]=[]);B[a].push([b,c])}};var t=function(a,b){var c=
j.createUID();this.data=$(ca);this.connections={};this.init(c,a);Object.keys(B).length&&(this._events=B);console.log("\n\t\t:: "+this.id+" ::\n");c=function(){K.init(this.id,b,function(a){a&&this.checkNewConnections([a])}.bind(this))}.bind(this);r.ready?c():r.add(c)};j.inherits(t,A);t.prototype.checkNewConnections=function(a,b){for(var c=this.connections,d=this.id,f,g=0,h=a.length;g<h;g++)f=a[g],f!==d&&!c[f]&&this.connect(f,!0,b)};t.prototype.connect=function(a,b,c){this.connections[a]||(b=new m(this.id,
a,b||!1,c),this.connections[a]=b,h.peers[a]=new A({id:a,connection:b}))};t.prototype.join=function(a,b){"/"==a.charAt(0)&&(a=a.substr(1));var c=["!/",a,j.createQuery(b)].join("");if(c==="!/"+s.currentRoute||d.location.hash)return Q();d.location.hash=c};t.prototype.media=function(){};t.prototype.send=function(a,b){b||(b=a,a=null);a||(a=["message"]);Array.isArray(a)||(a=[a]);var c=this.connections,d=Object.keys(c),f,g,h,j,k;g=0;for(h=d.length;g<h;g++){f=c[d[g]];j=0;for(k=a.length;j<k;j++)f.send(a,{local:this.name,
msg:b})}};h.loop=function(){};return h});
